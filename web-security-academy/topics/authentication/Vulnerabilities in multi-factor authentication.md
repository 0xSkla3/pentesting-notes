#websec #appsec #web-security-academy
#Authentication-vulnerabilities
Muchos sitios usan 2FA (doble factor de autenticacion), esto es un factor conocido sumado a un factor que se tiene.

Muchas veces se puede obtener el factor que se conoce (password) pero no el factor que se tiene. Asi mismo, una implementacion pobre de este medida, hace que pueda ser vulnerado o hasta completamente bypaseado.

Verificar el mismo factor por 2 vias distintas no constituye un 2FA real, ese es el caso del 2FA con email, ya que para acceder al email, necesitamos del las credenciales del mismo que es algo que conocemos.


## Bypass 2FA auth

Muchas veces, la aplicacion nos pide el token dejandonos en una instancia intermedia donde el estado del usuario ya esta como "logeado o validado". Para verificar esto, antes de ingresar el 2FA, probamos ir a una url que sea solo para usuarios logeados. A veces las webs no verifican si el usuario completo el segundo factor antes de asignar el estado de "logged-in".

> LAB [2FA simple bypass](https://portswigger.net/web-security/authentication/multi-factor/lab-2fa-simple-bypass)

## Flawed two-factor verification logic

otra flawed logic ocurre cuando no se verifica correctamente que se complete el segundo paso.

Ejemplo:

1. Logeamos con nuestras credenciales
```
POST /login-steps/first HTTP/1.1 
Host: vulnerable-website.com 
... 
username=carlos&password=qwerty`
```

2. Se asigna una cookie que esta relacionada a la cuenta que esta logeando
```
HTTP/1.1 200 OK 
Set-Cookie: account=carlos 

GET /login-steps/second HTTP/1.1 
Cookie: account=carlos
```

3.  Cuando enviamos el codigo de verificacion, la request usa dicha cookie para determinar a que cuenta se quiere logear.
```POST /login-steps/second HTTP/1.1 
Host: vulnerable-website.com 
Cookie: account=carlos 
... 
verification-code=123456
```

4. Se puede reemplazar el valor de la cuenta por una arbitraria al momento de enviar el codigo
```
POST /login-steps/second HTTP/1.1 
Host: vulnerable-website.com 
Cookie: account=victim-user 
... 
verification-code=123456
```

Esto puede ser extremandamente vulnerable si se puede hacer bruteforce sobre el codigo de verificacion, pudiendo lograr acceder a una cuenta arbitraria conociendo solo el nombre de usuario.

## Brute-forcing 2FA verification codes

Algunas webs intentan prevenir el bruteforce en los codigos de 2FA limitando la cantidad de intentos de ingresar codigos. Esto puede ser vulnerado si creamos un script que replique estos pasos. Se puede hacer facilmente creando una macro en burp intruder. Turbo intruder tambien se puede usar para esto.

- LAB [2FA bypass using a brute-force attack](https://portswigger.net/web-security/authentication/multi-factor/lab-2fa-bypass-using-a-brute-force-attack): te muestra como hacer macros y bruteforcear con ellas.

Fuentes: https://portswigger.net/web-security/authentication/multi-factor