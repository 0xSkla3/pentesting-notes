#windows
## Active Directory Fundamentals
### Terminology And Glosary

**Object:**
- anywhere object of AD

**Attributes:**
- [attributes](https://docs.microsoft.com/en-us/windows/win32/adschema/attributes-all) associat object

**Schema:**
- El [schema](https://docs.microsoft.com/en-us/windows/win32/ad/schema) es la relacion que tienen los objetos y sus atributos en el AD. Se extiende dinamicamente.

**Dominio:**
- Es un agrupamiento logico, funciona como contenedor de los demas objetos por debajo de el.

**Forest:**
- Coleccion de trees (dominio) de AD

**Tree: **
- A domain...

**Container:**
- Objeto que contiene otros objetos, con un lugar definido en el jerarquia del subtree

**GUID:**
-  [GUID](https://docs.microsoft.com/en-us/windows/win32/adschema/a-objectguid)valor de 128 bits unico asignado al crear una instancia de algo. Es cross a todo el dominio, no se puede reutilizar una vez eliminado la instancia del objeto.
- se almacena en el atributo `ObjectGUID`.

**Security Principals: 
- [Security principals](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-principals) son entidades que pueden ser autenticadas por el SO, como cuentas de usuarios, cuentas, computer accounts, hilos o procesos.
- En AD son objetos del dominio que pueden otorgar acceso a otros recursos del dominio.

**Security Identifier (SID):**
-  SID is used as a unique identifier for a security principal or security group.
- Every account, group, or process has its own unique SID, which, in an AD environment, is issued by the domain controller and stored in a secure database. 
- A SID can only be used once in a enviroment.
- There are also [well-known SIDs](https://ldapwiki.com/wiki/Well-known%20Security%20Identifiers) that are used to identify generic users and groups.

**Distinguished Name (DN):**
- A [Distinguished Name (DN)](https://docs.microsoft.com/en-us/previous-versions/windows/desktop/ldap/distinguished-names) describes the full path to an object in AD (such as `cn=bjones, ou=IT, ou=Employees, dc=onedomain, dc=local`).

**Relative Distinguished Name (RDN):**
- A [Relative Distinguished Name (RDN)](https://docs.microsoft.com/en-us/windows/win32/ad/object-names-and-identities) is a single component of the Distinguished Name that identifies the object as unique from other objects at the current level in the naming hierarchy.
-  AD does not allow two objects with the same name under the same parent container.

**sAMAccountName:**
- The [sAMAccountName](https://docs.microsoft.com/en-us/windows/win32/ad/naming-properties#samaccountname) is the user's logon name. Here it would just be `bjones`. It must be a unique value and 20 or fewer characters.

**userPrincipalName:**
- The [userPrincipalName](https://social.technet.microsoft.com/wiki/contents/articles/52250.active-directory-user-principal-name.aspx) attribute is another way to identify users in AD. `bjones@inlanefreight.local`
- This attribute is not mandatory.

**FSMO Roles**:
-  [Flexible Single Master Operation (FSMO)](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/fsmo-roles) roles give DC the ability to continue authenticating users and granting permissions whiout interruption. 
- There are five FMSO roles: 
	- `Schema Master` and `Domain Naming Master` (one of each per forest)
	- `Relative ID (RID) Master` (one per domain), `Primary Domain Controller (PDC) Emulator` (one per domain), and `Infrastructure Master` (one per domain).
- All five roles are assigned to the first DC in the forest root domain in a new AD forest

**Global Catalog**:
- The [global catalog (GC)](https://docs.microsoft.com/en-us/windows/win32/ad/global-catalog) stores a full copy of all objects in the current domain and a partial copy of objects that belong to other domains in the forest.
- GC is a feature that is enabled on a domain controller and performs the following functions:
	- **Authentication** (provided authorization for all groups that a user account belongs to, which is included when an access token is generated)
	- **Object search** (making the directory structure within a forest transparent, allowing a search to be carried out across all domains in a forest by providing just one attribute about an object.)

**Read-Only Domain Controller (RODC):**

Duda: si se usa [RODC filtered attribute set](https://learn.microsoft.com/en-us/windows/win32/ad/rodc-and-active-directory-schema#rodc-filtered-attribute-set) sobre credenciales, password o keys. como se puede logear de manera offline en este rodc local?

- A [RODC](https://docs.microsoft.com/en-us/windows/win32/ad/rodc-and-active-directory-schema) has a read-only Active Directory database.
- Is used in branch offices where a full domain controler cannot be placed.
- Allow users to perform logon and task like print/share file even when there is no network connectivity to hub sites.
- attribute  `RODC filtered`: prevent replicating to RODCs in the forest.

**Replication:**
- [Replication](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/replication/active-directory-replication-concepts) happens in AD when AD objects are updated and transferred from one Domain Controller to another.
- Whenever a DC is added, connection objects are created to manage replication between them. These connections are made by the Knowledge Consistency Checker (KCC) service, which is present on all DCs.

**Connection object:**
- A [connection object](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/replication/active-directory-replication-concepts#BKMK_1) is an Active Directory object that represents a replication connection from a source domain controller to a destination domain controller.

**Service Principal Name (SPN)**
- A [Service Principal Name (SPN)](https://docs.microsoft.com/en-us/windows/win32/ad/service-principal-names) uniquely identifies a service instance. They are used by Kerberos authentication to associate an instance of a service with a logon account, allowing a client application to request the service to authenticate an account without needing to know the account name.

**Group Policy Object (GPO):**
- [Group Policy Objects (GPOs)](https://docs.microsoft.com/en-us/previous-versions/windows/desktop/policy/group-policy-objects) are virtual collections of policy settings. Each GPO has a unique GUID. 
- A GPO can contain local file system settings or Active Directory settings.
- GPO settings can be applied to both user and computer objects. They can be applied to all users and computers within the domain or defined more granularly at the OU level.

**Access Control List (ACL):**
- An [Access Control List (ACL)](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-control-lists) is the ordered collection of Access Control Entities (ACEs) that apply to an object.

**Access Control Entities (ACEs):**
- Each [Access Control Entity (ACE)](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-control-entries) in an ACL identifies a trustee (user account, group account, or logon session) and lists the access rights that are allowed, denied, or audited for the given trustee.

**Discretionary Access Control List (DACL):**

- DACLs define which security principles are granted or denied access to an object; it contains a list of ACEs. 
- When a process tries to access a securable object, the system checks the ACEs in the object's DACL to determine whether or not to grant access. 
- If an object does NOT have a DACL, then the system will grant full access to everyone, but if the DACL has no ACE entries, the system will deny all access attempts. 
- ACEs in the DACL are checked in sequence until a match is found that allows the requested rights or until access is denied.

**Fully Qualified Domain Name (FQDN):**
- An FQDN is the complete name for a specific computer or host. It is written with the hostname and domain name in the format `[host name].[domain name].[tld]`
- example: 
	- Host: `DC01`, Domain: `ONEDOMAIN.LOCAL`
	- FQDN: `DC01.ONEDOMAIN.LOCAL`

**Tombstone**
- A [tombstone](https://ldapwiki.com/wiki/Tombstone) is a container object in AD that holds deleted AD objects, like a 'Recycle Bin' but not preserve attributes of then
- When an object is deleted from AD, the object remains for a set period of time known as the `Tombstone Lifetime,` and the `isDeleted` attribute is set to `TRUE`.
- Once an object exceeds the `Tombstone Lifetime`, it will be entirely removed.

**AD Recycle Bin:**
- When the AD Recycle Bin is enabled, any deleted objects are preserved for a period of time, facilitating restoration if needed.
- The [AD Recycle Bin](https://techcommunity.microsoft.com/t5/ask-the-directory-services-team/the-ad-recycle-bin-understanding-implementing-best-practices-and/ba-p/396944) is other container object in AD that holds deleted AD objects and those attributes are preserved.

**SYSVOL:**
- The [SYSVOL](https://social.technet.microsoft.com/wiki/contents/articles/8548.active-directory-sysvol-and-netlogon.aspx) folder, or share, stores copies of public files in the domain such as system policies, Group Policy settings, logon/logoff scripts, and often contains other types of scripts that are executed to perform various tasks in the AD environment.
- The contents of the SYSVOL folder are replicated to all DCs within the environment using File Replication Services (FRS). You can read more about the SYSVOL structure [here](http://www.techiebird.com/Sysvol_structure.html).

**AdminSDHolder:**
- The [AdminSDHolder](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory) object is used to manage ACLs for members of built-in groups in AD marked as privileged. It acts as a container that holds the Security Descriptor applied to members of protected groups.
- AdminSDHolder is automatically created as an object in the System container of every Active Directory domain. Its path is: **CN=AdminSDHolder,CN=System,DC=<domain_component>,DC=<domain_component>?.**
- Unlike most objects in the Active Directory domain, which are owned by the Administrators group, AdminSDHolder is owned by the Domain Admins group.

**SDProp:**
- [SDProp](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory#sdprop) is a process that runs every 60 minutes (by default) on the domain controller that holds the domain's PDC Emulator (PDCE). SDProp compares the permissions on the domain's AdminSDHolder object with the permissions on the protected accounts and groups in the domain. If the permissions on any of the protected accounts and groups do not match the permissions on the AdminSDHolder object, the permissions on the protected accounts and groups are reset to match those of the domain's AdminSDHolder object.

**dsHeuristics:**
- The [dsHuerisitcs](https://docs.microsoft.com/en-us/windows/win32/adschema/a-dsheuristics) attribute is a string value set on the Directory Service object used to define multiple forest-wide configuration settings. 
- One of these settings is to exclude built-in groups from the [Protected Groups](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory) list. Groups in this list are protected from modification via the `AdminSDHolder` object. If a group is excluded via the `dsHeuristics` attribute, then any changes that affect it will not be reverted when the SDProp process runs.

**adminCount:**
The [adminCount](https://docs.microsoft.com/en-us/windows/win32/adschema/a-admincount) attribute determines whether or not the SDProp process protects a user. If the value is set to `0` or not specified, the user is not protected. If the attribute value is set to `value`, the user is protected. Attackers will often look for accounts with the `adminCount` attribute set to `1` to target in an internal environment. These are often privileged accounts and may lead to further access or full domain compromise.

**Active Directory Users and Computers (ADUC):**
ADUC is a GUI console commonly used for managing users, groups, computers, and contacts in AD. Changes made in ADUC can be done via PowerShell as well.

**ADSI Edit:**
ADSI Edit is a GUI tool used to manage objects in AD. It provides access to far more than is available in ADUC and can be used to set or delete any attribute available on an object, add, remove, and move objects as well. It is a powerful tool that allows a user to access AD at a much deeper level. Great care should be taken when using this tool, as changes here could cause major problems in AD.

**sIDHistory:**
- [This](https://docs.microsoft.com/en-us/defender-for-identity/cas-isp-unsecure-sid-history-attribute) attribute holds any SIDs that an object was assigned previously. It is usually used in migrations so a user can maintain the same level of access when migrated from one domain to another. 
- This attribute can potentially be abused if set insecurely, allowing **an attacker to gain prior elevated access that an account had before a migration if SID Filtering** (or removing SIDs from another domain from a user's access token that could be used for elevated access) **is not enabled.**

**NTDS.DIT:**
- The NTDS.DIT file can be considered the heart of Active Directory. It is stored on a Domain Controller at `C:\Windows\NTDS\` and is a database that stores AD data such as information about user and group objects, group membership, and **the password hashes for all users in the domain.** 
- Once full domain compromise is reached, an attacker can retrieve this file, extract the hashes, and either use them to perform a pass-the-hash attack or crack them offline using a tool such as Hashcat to access additional resources in the domain. If the setting [Store password with reversible encryption](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) is enabled, then the NTDS.DIT will also store the cleartext passwords for all users created or who changed their password after this policy was set. While rare, some organizations may enable this setting if they use applications or protocols that need to use a user's existing password (and not Kerberos) for authentication.


### AD Objects

**Users:**
- Leaf objects.
- Is a security principal -> have a security identifier **(SID) and global unique indentifier (GUID)**
- Have a lot of possibles attributes
- They are a crucial target for attackers since gaining access to even a low privileged user can grant access to many objects and resources and allow for detailed enumeration of the entire domain (or forest).

**Contacts:**
- Leaf objects
- Are not security principals, don´t have SID, **only GUID**.
- Attributes such as first name, last name, email address, telephone number, etc.

**Printers:**
- Leaf objects.
- Only **have GUID**.
- Attributes such as the printer's name, driver information, port number, etc.

**Computers:**
- Leaf objects.
- Are security principal and **have SID and GUID**.
- Like users, they are prime targets for attackers since full administrative access to a computer (as the all-powerful `NT AUTHORITY\SYSTEM` account) grants similar rights to a standard domain user and can be used to perform the majority of the enumeration tasks that a user account can (save for a few exceptions across domain trusts.)

**Shared Folders:**
- A shared folder object points to a shared folder on the specific computer where the folder resides.
- have stringent access control:
	- applied to them and can be either accessible to everyone
	- open to only authenticated users
	- or be locked down to only allow certain users/groups access.
	- Anyone not explicitly allowed access will be denied from listing or reading its contents.
	- have only GUID

**Groups:**
- Considered a container object because it can contain other objects, including users, computers and even other groups.
- Is a security principal -> have SID and GUID.
- We commonly see what are called "[nested groups](https://docs.microsoft.com/en-us/windows/win32/ad/nesting-a-group-in-another-group)"  which can lead to a user(s) obtaining unintended rights.
- **Nested group membership is something we see and often leverage during penetration tests.** The tool [BloodHound](https://github.com/BloodHoundAD/BloodHound) helps to discover attack paths within a network and illustrate them in a graphical interface

**Organizational Units:**
- An OU is a container that systems administrators can use to store similar objects for ease of administration. (like inheritance).
- OUs are very useful for managing Group Policy settings across a subset of users and groups within a domain.
- An OU can have multiple OUs within it, but all attributes within the containing OU must be unique.

**Domain**:
- A domain is the structure of an AD network. Domains contain objects such as users and computers, which are organized into container objects: groups and OUs. 
- Every domain has its own separate database and sets of policies that can be applied to any and all objects within the domain.

**Domain Controller:**
- Domain Controllers are essentially the brains of an AD network. 
- They handle authentication requests, verify users on the network, and control who can access the various resources in the domain. 
- All access requests are validated via the domain controller and privileged access requests are based on predetermined roles assigned to users. 
- It also enforces security policies and stores information about every other object in the domain.


**Sites:**
- A site in AD is a set of computers across one or more subnets connected using high-speed links. They are used to make replication across domain controllers run efficiently.

 **Built-in:**
- In AD, built-in is a container that holds [default groups](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups) in an AD domain. They are predefined when an AD domain is created.

**Foreign Security Principals:**
- A foreign security principal (FSP) is an object created in AD to represent a security principal that belongs to a trusted external forest. 
- They are created when an object such as a user, group, or computer from an external (outside of the current) forest is added to a group in the current domain. 
- They are created automatically after adding a security principal to a group. 
- Every foreign security principal is a placeholder object that holds the SID of the foreign object (an object that belongs to another forest.) Windows uses this SID to resolve the object's name via the trust relationship. FSPs are created in a specific container named ForeignSecurityPrincipals with a distinguished name like `cn=ForeignSecurityPrincipals,dc=onadomain,dc=local`.

### AD Functionality

Flexible Single Master Operation [FSMO](https://www.lepide.com/blog/5-fsmo-roles-active-directory/) roles.


| **Roles** | **Description** |
| --------------|-------------------|
|`Schema Master` |This role manages the read/write copy of the AD schema, which defines all attributes that can apply to an object in AD. |
| `Domain Naming Master` | Manages domain names and ensures that two domains of the same name are not created in the same forest. |
| `Relative ID (RID) Master` | The RID Master assigns blocks of RIDs to other DCs within the domain that can be used for new objects. The RID Master helps ensure that multiple objects are not assigned the same SID. Domain object SIDs are the domain SID combined with the RID number assigned to the object to make the unique SID.
| `PDC Emulator` | The host with this role would be the authoritative DC in the domain and respond to authentication requests, password changes, and manage Group Policy Objects (GPOs). The PDC Emulator also maintains time within the domain. |
| `Infrastructure Master` | This role translates GUIDs, SIDs, and DNs between domains. This role is used in organizations with multiple domains in a single forest. The Infrastructure Master helps them to communicate. If this role is not functioning properly, Access Control Lists (ACLs) will show SIDs instead of fully resolved names. |

**Domain and Forest Functional Levels:**

- Microsoft introduced functional levels to determine the various features and capabilities available in Active Directory Domain Services (AD DS) at the domain and forest level.

**Trust:**
- A trust is used to establish `forest-forest` or `domain-domain` authentication, allowing users to access resources in (or administer) another domain outside of the domain their account resides in. A trust creates a link between the authentication systems of two domains.
- Trust can be transitive or non-transitive:
	- Transitive: A transitive trust means that trust is extended to objects that the child domain trusts.
	- Non-transitive: In a non-transitive trust, only the child domain itself is trusted.
- Trust can be one-way or two-way directional:
	- one-way: In a one-way trust, only users in a trusted domain can access resources in a trusting domain, not vice-versa. The direction of trust is opposite to the direction of access.
	- two-way: In bidirectional trusts, users from both trusting domains can access resources.

| **Trust Type** | **Description** |
| --------------|-------------------|
| `Parent-child` | Domains within the same forest. The child domain has a two-way transitive trust with the parent domain. | 
| `Cross-link` | a trust between child domains to speed up authentication.
| `External` | A non-transitive trust between two separate domains in separate forests which are not already joined by a forest trust. This type of trust utilizes SID filtering. |
| `Tree-root` | a two-way transitive trust between a forest root domain and a new tree root domain. They are created by design when you set up a new tree root domain within a forest. |
| `Forest` | a transitive trust between two forest root domains. |


## AD Protocols

**Kerberos:**


**DNS:**
- AD DS use DNS to allow clients to locate DC and for DC that host the directory service to comunicate amongst themselves.
- Private internal networks use AD DNS namespaces to facilitate communications between servers, clients, and peers.
- AD maintains a db of services running on the network in the form of service records (SRV). The service records allow clients in an AD to locate service that they need such as file server, printer or DC.
- Use TCP and UDP port 53. UDP port 53 is the default, but is falls, use TCP.

**Forward DNS Lookup:**

We can perform a `nslookup` for the domain name and retrieve all Domain Controllers' IP addresses in a domain.
```powershell
nslookup INLANEFREIGHT.LOCAL

Server:  172.16.6.5
Address:  172.16.6.5

Name:    INLANEFREIGHT.LOCAL
Address:  172.16.6.5
```

**Reverse DNS Lookup:**
If we would like to obtain the DNS name of a single host using the IP address, we can do this as follows:

```powershell
nslookup 172.16.6.5

Server:  172.16.6.5
Address:  172.16.6.5

Name:    ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
Address:  172.16.6.5
```


**LDAP:**
- LDAP is an open-source and cross-platform protocol used for authentication against various directory services (such as AD).
- The latest LDAP specification is [Version 3](https://tools.ietf.org/html/rfc4511), published as RFC 4511.
- LDAP uses port 389, and LDAP over SSL (LDAPS) communicates over port 636.
- LDAP is the language that applications use to communicate with other servers that provide directory services.
- An LDAP session begins by first connecting to an LDAP server, also known as a Directory System Agent. The Domain Controller in AD actively listens for LDAP requests, such as security authentication requests.
- The relationship between AD and LDAP can be compared to Apache and HTTP. The same way Apache is a web server that uses the HTTP protocol, Active Directory is a directory server that uses the LDAP protocol.
- While uncommon, you may come across organization while performing an assessment that do not have AD but are using LDAP, meaning that they most likely use another type of LDAP server such as [OpenLDAP](https://en.wikipedia.org/wiki/OpenLDAP).

**AD LDAP Authentication:**

LDAP "bindea" el estado de autenticacion de una sesion de LDAP. Existen 2 tipos:
- Simple Auth :
	- auth anonima, auth no autenticada y auth de username/password. La autenticación simple significa que un nombre de usuario y una contraseña crean una solicitud BIND para autenticarse en el servidor LDAP.
- SASL Auth : Simple Auth and Security Layer (SASL) framework usa otro servicio de auth como kerberos para bindear el LDAP sv y luego autenticarse contra el.

Los mensajes de LDAP auth van en texto plano por la red por defecto.

**MSRPC:**
Microsoft Remote Procedure Call (RPC). es utilizado por sistemas windows para aaceder a sistemas en el AD mediante 4 interfaces clave.

- `lsarpc`: set de calls RPC del `Local Security Authority` (`LSA`) que administra las security policies locales en un ordenador. `LSARPC` se utiliza para realizar la gestión de las políticas de seguridad del dominio.
-  `netlogon` : es un proceso de windows isado para autenticar usuarios y otros servicios en el dominio. Esta continuamente corriendo en background.
- `samr` : Remose SAM (samr) tiene funcionalidades de gestion para la db de cuentas de dominios.Se utiliza para administrar los security principals (users, groups, etc...). Se puede utilizar para hacer recon sobre el dominio usando [BloodHound](https://github.com/BloodHoundAD/). Se puede [proteger el dominio](https://blog.netwrix.com/2022/11/18/making-internal-reconnaissance-harder-using-netcease-and-samri1o/) de este ataque cambiando un registro de Windows para habilitar las consultas `samr` solo para admins. Por defecto cualquier usuario autenticado puede realizarlas.
-  `drsuapi` : implementacion de `Directory Reokucatuib Service` (DRS) que se usa para tareas relacionadas con la replicacion a travez de varios DC en un entorno multi-DC. Se puede utilizar para [dumpear](https://attack.mitre.org/techniques/T1003/003/) la db del AD (`NTDS.dit`), un archivo que contiene las pwd de las cuentas en el dominio hasheadas.


## NTLM Authentication 

#### **`LAN Manager` (LM or LANMAN):** 
- Case insensitive, se pasa a mayusculas la contraseña dejando asi un keyspace de 69 caracteres.
- Maximo de 14 caracteres, 2 chunks de 7 caracteres.
- Padding con NULL en caso de que sea menor a 14 caracteres.
- Se encripta cada chunk con DES, con la key `KGS!@#$%`, obteniendo 2 chunks de 8-byte cifrados. 
-  Se concatenan los chunks cifrados y se obtiene el hash LM.
- Se puede deshabilitar su uso con las  [Group Policy](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/network-security-do-not-store-lan-manager-hash-value-on-next-password-change). 
- Ej de hash LM: `299bd128c1101fd6`

#### NTHash (NTLM)
- Es un protocolo de autenticacion challengue-response y usa 3 mensajes para autenticar:
	1. el cliente envia `NEGOTIATE_MESSAGE` al server.
	2. el server responde con el `CHALLENGE_MESSAGE` al cliente.
	4. el cliente envia el `AUTHENTICATE_MESSAGE`.
- Los hashes se almacenan localmente en la SAM o NTDS.DIT en el DC.
- Soporta Unicode (65536 symbols)
- Vulnerable a pass-the-hash
- Es la segunda mitad de un hash completo NTLM
  
  
NTLM Authentication Request
`username:RID:LM-hash:NT-hash:::`
```powershell
Rachel:500:aad3c435b514a4eeaad3b935b51304fe:e46b9e548fa0d122de7f59fb6d48eaa2:::
```


> **Nota: Ni LANMAN ni NTLM usa salt.**

### NTLMv1 (Net-NTMLv1)
- Protocolo challenge/response.
- Utiliza tanto LM como NT hash.
- el hash Net-NTLMv1 se crea a partir de un algoritmo challenge/response
- No sirve para hacer pass-the-hash.
- Se puede capturar con  [Responder](https://github.com/lgandx/Responder) o via con un [NTLM relay attack](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html).
- ESTA EN DESUSO.
  
**V1 Challenge & Response Algorithm**
```c
C = 8-byte server challenge, random
K1 | K2 | K3 = LM/NT-hash | 5-bytes-0
response = DES(K1,C) | DES(K2,C) | DES(K3,C)
```

Ej NTLMv1 hash
```
u4-netntlm::kNS:338d08f8e26de93300000000000000000000000000000000:9526fb8c23a90751cdd619b6cea564742e1e4bf33006ba41:cb8086049ec4736c
```

Cada parte del hash está separada por el caracter ":", y representa los siguientes elementos:

-   `"u4-netntlm"` es el dominio del usuario (o en este caso, el valor predeterminado que se usa en algunas implementaciones de NTLM).
-   `""` es el nombre de usuario (en este caso, una cadena vacía).
-   `"kNS"` es el desafío enviado por el servidor (SC).
-   `"338d08f8e26de93300000000000000000000000000000000"` es la respuesta del cliente (response) generada por el algoritmo de desafío y respuesta NTLMv1. Este valor consta de dos partes: la primera parte (que comienza con `"338d"`) es un hash MD4 de la contraseña del usuario en formato Unicode, y la segunda parte (que consiste en ceros) se agrega para hacer que la respuesta tenga una longitud de 24 bytes.
-   `"9526fb8c23a90751cdd619b6cea564742e1e4bf33006ba41"` es una clave de sesión generada a partir del desafío del servidor (SC) y la respuesta del cliente (response).
-   `"cb8086049ec4736c"` es la respuesta del cliente cifrada (NTLMv1). Este valor se genera cifrando el desafío del servidor (SC) con la clave de sesión.

### NTLMv2 (Net-NTLMv2)
- Protocolo challenge/response.
- Utiliza solo el NT
- Envia 2 respuestas al challenge recibido por el server.
	1. La primera contiene un hash HMAC-MD5 de 16 bytes del challenge, un challenge generado aleatoriamente por el cliente y un hash HMAC-MD5 de las credenciales del usuario.
	2. Se envía una segunda respuesta, utilizando un challenge del cliente de longitud variable que incluye la hora actual, un valor aleatorio de 8 bytes y el nombre del dominio.
- No requiere una conexion de red persistente para funcionar.

  V2 Challenge & Response Algorithm
```c
SC = 8-byte server challenge, random
CC = 8-byte client challenge, random
CC2 = 8-byte second client challenge, random
CC* = (X, time, CC2, domain name)
v2-Hash = HMAC-MD5(NT-Hash, user name, domain name)
LMv2 = HMAC-MD5(v2-Hash, SC, CC)
NTv2 = HMAC-MD5(v2-Hash, SC, CC*)
response = LMv2 | CC | NTv2 | CC*
```

Ej NTLMv2 Hash
```
admin::N46iSNekpT:08ca45b7d7ea58ee:88dcbe4446168966a153a0064958dac6:5c7830315c7830310000000000000b45c67103d07d7b95acd12ffa11230e0000000052920b85f78d013c31cdb3b92f5d765c783030
```

Cada parte de la cadena hash se separa por el carácter ":" y corresponde a los siguientes elementos:

-   `"admin"` es el nombre de usuario.
- `"N46iSNekpT"` es la contraseña del usuario en formato LM.
-   `"08ca45b7d7ea58ee"`: Service Challenge (SC).
-   `"88dcbe4446168966a153a0064958dac6"`: hash de la contraseña del usuario (NT-Hash).
- `"5c7830315c7830310000000000000b45c67103d07d7b95acd12ffa11230e0000000052920b85f78d013c31cdb3b92f5d765c783030"`:  response del cliente.

[NTLMv1 vs NTLMv2: Digging into an NTLM Downgrade Attack](https://www.praetorian.com/blog/ntlmv1-vs-ntlmv2/#:~:text=Unsurprisingly%2C%20the%20NTLMv2%20hash%20format,challenge%2C%20and%20the%20AV_PAIR%20bytes).
[Abusing LLMNR/NBT-NS in Active Directory Domains: Part 2 (Cracking NTLMv2 Hashes w/ Hashcat)](https://infinitelogins.com/2020/04/16/abusing-llmnr-nbtns-part-2-cracking-ntlmv2-hashes/). 

### Domain Cached Credentials (DCC)(MSCache2)
- Guarda los 10 ultimos hashes para cualquier usuario del dominio que logea correctameente dentro del host, guardandolo en el registro `HKEY_LOCAL_MACHINE\SECURITY\Cache` 
- Estos hashes no se pueden usar para pass-the-hash
- Muy lentos para crackearlos
- format: `$DCC2$10240#bjones#e4e938d12fe5974dc42a90120bd9c90f`


## User and Machine Accounts

### Local Accounts
- Son considerados Security Principals, pero todo permiso otorgado es dentro del host especifico.
-  [local default accounts](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/local-accounts):
	1. `Administrator`: 
		- SID: `S-1-5-domain-500`.
		- Primer cuenta creada en el SO.
		- No puede ser borrada o bloqueada, pero si deshabilitada o renombrada.
		- Deshabilitada por default en w10 y server 2016.
	2. `Guest`: Deshabilitada por default por problemas de seguridad ya que no necesita pwd.
	3. `SYSTEM` o `NT AUTHORITY\SYSTEM`: 
		- Cuenta por defecto usada por el SO donde tiene permisos completos sobre todo el sistema.
		- Muchos procesos pueden correr bajo este contexto
		- No existe un perfil como tal de esta cuenta.
		- No puede ser agregada a grupos.
		- No se ve en el User Manager.
	4. `Network Service`: 
		- Utilizadas por el SCM para correr servicios.
		- Presenta credenciales a servicios remotos.
	5. `Local Service`: 
		- Utilizado por el SCM para correr servicios.
		- Configurada con privilegios minimos en el host y presenta credenciales anonimas a la red.

### Domain Users
- Pueden logear en cualquier host de la red
- La cuenta `KRBTGT` viene dentro de la infra de AD cuando este se crea, funciona como cuenta de servicio para el KDC. [Golden Ticket](https://attack.mitre.org/techniques/T1558/001/)

[SDProp AdminSDHolder Attack](https://www.netwrix.com/adminsdholder_modification_ad_persistence.html)

### User Naming Attributes
- `UserPrincipalName` (UPN): suele ser el mail del usuario.
- `ObjectGUID`: Unico, nunca cambia, permanece unico incluso borrando el usuario. 
- `SAMAccountName`: logon name para versiones viejas.
- `objectSID`
- `sIDHistory`: Contiene los SID que tuvo un usuario frente a migraciones de dominio.

Common [User Attributes](https://learn.microsoft.com/en-us/windows/win32/ad/user-object-attributes)
```powershell
PS C:\htb Get-ADUser -Identity htb-student

DistinguishedName : CN=htb student,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
Enabled           : True
GivenName         : htb
Name              : htb student
ObjectClass       : user
ObjectGUID        : aa799587-c641-4c23-a2f7-75850b4dd7e3
SamAccountName    : htb-student
SID               : S-1-5-21-3842939050-3880317879-2865463114-1111
Surname           : student
UserPrincipalName : htb-student@INLANEFREIGHT.LOCAL
```

### Domain-joined vs. Non-Domain-joined Machines

1. `Domain joined`: 
	- Cualquier usuario dentro del dominio puede logear en ella.
	- Adquiere cualquier configuracion o cambio a traves de las GP del dominio.
2.  `Non-domain joined` o `workgroup`:
	- No son administradas por GP.
	- Los usuarios son responsables de cualquier cambio a realizar en el host.
	- Las cuentas de usuario viven solo en el host y no se migran a otros host dentro del workgroup

> Nota: Una cuenta local con nivel de accesos de `NT AUTHORITY\SYSTEM` en un AD cuenta con la mayoria de los permisos que un usuario de AD estandard. Esto nos permite empezar a enumerar el dominio ya que tenemos acceso de lectura a la mayoria de los datos dentro del mismo.


## AD Grupos

### Tipos de grupos

#### Security Groups
- Se usan para asignar permisos y derechos a colecciones de usuarios.
- Los usuarios agregados a un security group heredan los permisos asignados a ese grupo.

	User rights are different from permissions because **user rights apply to user accounts, and permissions are associated with objects**. Although user rights can apply to individual user accounts, user rights are best administered on a group account basis.

#### Distribution Group
- Usado por aplicaciones de mail y funcionan como listas de emails.

### Groups Scope

1. Domain Local Group (DLG)
	- Se puede usar solo para manejar permisos en los recursos del propio dominio donde se crea.
	- No se pueden usar en otros dominios pero `PUEDE` contener usuarios de `OTROS` dominios.
1. Global Group (GG)
	- Puede usarse para conceder acceso a recursos de `otro dominio`.
	- Solo puede contener cuentas del dominio donde se creó.
	- Puede añadirse a grupos locales como a otros grupos globales.
1. Universal Group (UG)
	- Puede administrar recursos de distintos dominios y dar permisos a cualquier objeto dentro del mismo `forest`, como asi tambien contener usuarios de distintos dominios del mismo `forest`.
	- Se guarda dentro del Global Catalog (`GC`).
	- Agregar o remover objetos del grupo trigerea la replicacion del cambio a travez de todo el `forest`.
	- Se recomienda tener grupos globales como miembros del grupo universal. Si se agrega/quita un usuario dentro del grupo global, este trigerea la replica solo en su dominio.
	- Si usuarios/pc se agregan individualmente a los grupos universales, crea sobrecarga en la red por la replicacion y puede provocar errores.


AD Group Scope Examples
```powershell
PS C:\htb> Get-ADGroup  -Filter * |select samaccountname,groupscope

samaccountname                           groupscope
--------------                           ----------
Administrators                          DomainLocal
Users                                   DomainLocal
Guests                                  DomainLocal
Print Operators                         DomainLocal
Backup Operators                        DomainLocal
Replicator                              DomainLocal
Remote Desktop Users                    DomainLocal
Network Configuration Operators         DomainLocal
Distributed COM Users                   DomainLocal
IIS_IUSRS                               DomainLocal
Cryptographic Operators                 DomainLocal
Event Log Readers                       DomainLocal
Certificate Service DCOM Access         DomainLocal
RDS Remote Access Servers               DomainLocal
RDS Endpoint Servers                    DomainLocal
RDS Management Servers                  DomainLocal
Hyper-V Administrators                  DomainLocal
Access Control Assistance Operators     DomainLocal
Remote Management Users                 DomainLocal
Storage Replica Administrators          DomainLocal
Domain Computers                             Global
Domain Controllers                           Global
Schema Admins                             Universal
Enterprise Admins                         Universal
Cert Publishers                         DomainLocal
Domain Admins                                Global
Domain Users                                 Global
Domain Guests                                Global

<SNIP>
```

Restricciones sobre el cambio de `scope`
- Global group -> Universal group, si este NO es parte de otro Global Group.
- Domain Local Group -> Universal Group, si el DLG no contiene a otro DLG como miembro.
- Universal Group -> Domain Local Group sin restricciones.
- Universal Group -> Global Group, si este NO contiene ningun Universal Group.

### Built-In vs Custom Groups

1. [built-in groups](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#about-active-directory-groups):
	- Varios Domain Local Groups son creados al crear el dominio. Estos son de proposito administrativo.
	- Estos grupos pueden solo contener cuentas de usuarios y no pueden ser anidados en otros grupos.
	- `Domain Admins` es Global
	- Si quiero que un user del dominio A sea admin sea admin de un dc en el dominio B, lo agrego al grupo `Administrators` del dominio B.
	- Cambios/adiciones en el entorno de AD puede provocar la creacion de otros grupos. Ej: al agregar Microsoft Exchange, este agrega varios `security groups`, algunos de ellos con privilegios altos el cual se pueden explotar si no son administrados debidamente.

Built-in AD Security Groups
![[def-sec-groups.png]]

### Nested Group Membership (grupos anidados)

- Se puede otorgar permisos inintencionados a travez de la anidacion de los grupos, sin tener que darle el permiso directo a un usuario miembro del grupo anidado.
- [BloodHound](https://github.com/BloodHoundAD/BloodHound) es clave para analizar en profundidad los privilegios heredaros sobre los usuarios y grupos anidados.


### Atributos de grupos importantes
- Tienen varios [attributes](http://www.selfadsi.org/group-attributes.htm), de entre ellos los mas [importantes](https://docs.microsoft.com/en-us/windows/win32/ad/group-objects) son:
	- `cn`: `cn` o `Common-Name` es el nombre en el AD Domain Service.
	- `member`: cada usuario, grupo u objecto que es miembro del grupo.
	- `groupType`: un Integer que especifica el tipo y scope del grupo.
	- `memberOf`: Lista de todos los grupos que contienen al grupo como miembro.
	- `objectSid`: Sid del grupo que lo identifica como un `security principal`.


## Active Directory Rights and Privileges

- `Rights` suelen asignarse a usuarios o grupos y tratan con los permisos para acceder a un objeto, como un archivo,
- `Privileges` otorgan a un usuario el permiso para realizar una acción, como ejecutar un programa, apagar un sistema, restablecer contraseñas, etc.

> `User Rights Assignment`, aunque se refiere como derechos, son en realidad tipos de privilegios otorgados a un usuario.

### Built-in AD Groups
 [default or built-in security groups](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups)
| Group Name                              | Descripción                                                                                                                                                                                                                                                                                                                                                                                                           |
|-----------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `Account Operators`                         | Los miembros pueden crear y modificar la mayoría de los tipos de cuentas, incluyendo usuarios, grupos locales y grupos globales, y pueden iniciar sesión localmente en los controladores de dominio. No pueden administrar la cuenta de Administrador, las cuentas de usuario administrativas o los miembros de los grupos Administradores, Operadores de servidor, Operadores de cuenta, Operadores de copia de seguridad o Operadores de impresión. |
| `Administrators`                            | Los miembros tienen acceso completo e irrestricto a una computadora o a todo el dominio si están en este grupo en un controlador de dominio.                                                                                                                                                                                                                                                                             |
| `Backup Operators`                          | Los miembros pueden hacer copias de seguridad y restaurar todos los archivos en una computadora, independientemente de los permisos establecidos en los archivos. Los Operadores de copia de seguridad también pueden iniciar sesión y apagar la computadora. Los miembros pueden iniciar sesión en DC localmente y deben considerarse como Administradores del dominio. Pueden hacer copias de sombra de la base de datos SAM/NTDS, que, si se toman, se pueden utilizar para extraer credenciales y otra información valiosa.  |
| `DnsAdmins`                                | Los miembros tienen acceso a la información de DNS de la red. El grupo solo se creará si el rol de servidor DNS está o estuvo alguna vez instalado en un controlador de dominio en el dominio.                                                                                                                                                                                                                             |
| `Domain Admins`              | Los miembros tienen acceso completo para administrar el dominio y son miembros del grupo de administradores local en todas las máquinas unidas al dominio.                                                                                                                                                                                                                                                                  |
| `Domain Computers`                     | Cualquier computadora creada en el dominio (aparte de los controladores de dominio) se agrega a este grupo.                                                                                                                                                                                                                                                                                                           |
| `Domain Controllers`                | Contiene todos los controladores de dominio dentro de un dominio. Los nuevos controladores de dominio se agregan automáticamente a este grupo.                                                                                                                                                                                                                                                                            |
| `Domain Guests`                   | Este grupo incluye la cuenta de Invitado incorporada del dominio. Los miembros de este grupo tienen un perfil de dominio creado al iniciar sesión en una computadora unida al dominio como invitado local.                                                                                                                                                                                                                |
| `Domain Users`                    | Este grupo contiene todas las cuentas de usuario en un dominio. Una nueva cuenta de usuario creada en el dominio se agrega automáticamente a este grupo.                                                                                                                                                                                                                                                               |
| `Enterprise Admins`           | La membresía en este grupo proporciona acceso completo a la configuración dentro del dominio. El grupo solo existe en el dominio raíz de un bosque de AD. Los miembros de este grupo tienen la capacidad de realizar cambios en todo el bosque, como agregar un dominio hijo o crear una confianza. La `cuenta de Administrador del dominio raíz del bosque` es el único miembro de este grupo de forma predeterminada.                    |
| `Event Log Readers`         | Los miembros pueden leer los registros de eventos en las computadoras locales. El grupo solo se crea cuando se promueve un host a controlador de dominio.                                                                                                                                                                                                                                                                |
| `Group Policy Creator Owners` | Los miembros pueden crear, editar o eliminar `Group Policy Objects` en el dominio.
| `Hyper-V Administrators` | Los miembros tienen acceso completo e irrestricto a todas las funciones en Hyper-V. Si hay controladores de dominio virtual en el dominio, cualquier administrador de virtualización, como miembros de Hyper-V Administrators, deben ser considerados Administradores de Dominio. |
| `IIS_IUSRS` | Este es un grupo integrado utilizado por Internet Information Services (IIS), a partir de IIS 7.0. |
| `Pre–Windows 2000 Compatible Access` | Este grupo existe para la compatibilidad con versiones anteriores para computadoras que ejecutan Windows NT 4.0 y versiones anteriores. La pertenencia a este grupo a menudo es una configuración heredada. Puede llevar a fallas en las que cualquier persona en la red pueda leer información de AD sin requerir un nombre de usuario y contraseña válido de AD. |
| `Print Operators` | Los miembros pueden administrar, crear, compartir y eliminar impresoras que están conectadas a los controladores de dominio en el dominio junto con cualquier objeto de impresora en AD. **Los miembros pueden iniciar sesión en DC localmente y se pueden utilizar para cargar un controlador de impresora malintencionado y escalar privilegios dentro del dominio.** |
| `Protected Users` | Los miembros de este [grupo](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#protected-users) reciben protecciones adicionales contra el robo de credenciales y tácticas como el abuso de Kerberos. |
| `Read-only Domain Controllers` | Contiene todos los controladores de dominio de solo lectura en el dominio. |
| `Remote Desktop Users` | Este grupo se utiliza para otorgar permisos a usuarios y grupos para conectarse a un host a través de Remote Desktop (RDP). Este grupo no se puede cambiar de nombre, eliminar ni mover. |
| `Remote Management Users` | Este grupo se puede usar para otorgar acceso remoto a los usuarios a través de Windows Remote Management (WinRM). |
| `Schema Admins` | Los miembros pueden modificar el esquema de Active Directory, que es la forma en que se definen todos los objetos con AD. Este grupo solo existe en el dominio raíz de un bosque de AD. La `cuenta de Administrador del dominio raíz del bosque` es el único miembro de este grupo de forma predeterminada. |
| `Server Operators` | Este grupo solo existe en los controladores de dominio. Los miembros pueden modificar servicios, acceder a recursos compartidos SMB y realizar copias de seguridad de archivos en los controladores de dominio. De forma predeterminada, este grupo no tiene miembros. |

Server Operators Group Membership
```powershell
PS C:\htb>  Get-ADGroup -Identity "Server Operators" -Properties * | select DistinguishedName,GroupCategory,GroupScope,Name,Members


DistinguishedName : CN=Server Operators,CN=Builtin,DC=INLANEFREIGHT,DC=LOCAL
GroupCategory : Security
GroupScope : DomainLocal
Name : Server Operators
Members : {}
```

Domain Admins Group Membership
```powershell
PS C:\htb>  Get-ADGroup -Identity "Domain Admins" -Properties * | select DistinguishedName,GroupCategory,GroupScope,Name,Members

DistinguishedName : CN=Domain Admins,CN=Users,DC=INLANEFREIGHT,DC=LOCAL
GroupCategory     : Security
GroupScope        : Global
Name              : Domain Admins
Members           : {CN=htb-student_adm,CN=Users,DC=INLANEFREIGHT,DC=LOCAL, CN=sharepoint admin,CN=Users,DC=INLANEFREIGHT,DC=LOCAL, CN=FREIGHTLOGISTICSUSER,OU=ServiceAccounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL, CN=PROXYAGENT,OU=ServiceAccounts,OU=Corp,DC=INLANEFREIGHT,DC=LOCAL...}
```

### User Rights Assignment

>  [User Rights Assignment](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/user-rights-assignment): a detailed explanation of each of the user rights that can be set in Windows.
>  [SharpGPOAbuse](https://github.com/FSecureLABS/SharpGPOAbuse)

Algunos privilegios de interes:
| Privilege               | Description                                                                                                                                                |
|------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `SeRemoteInteractiveLogonRight` | Otorga el derecho a iniciar sesión en un host a través de Escritorio remoto (RDP). |
| `SeBackupPrivilege`       | Otorga el poder crear backups del sistema y podría ser utilizado para obtener copias de archivos de sistema sensibles que se pueden utilizar para recuperar contraseñas como las de la `SAM` y `SYSTEM Regystry` y el archivo de base de datos de Active Directory `NTDS.dit`.|
| `SeDebugPrivilege`        | Esto permite a un usuario depurar y ajustar la memoria de un proceso. Con este privilegio, con una herramienta como `Mimikatz` se puede leer el espacio de memoria del proceso Local System Authority (LSASS) y obtener cualquier credencial almacenada en memoria.|
| `SeImpersonatePrivilege`  | Este privilegio nos permite suplantar un token de una cuenta privilegiada como `NT AUTHORITY\SYSTEM`. Esto podría ser aprovechado con una herramienta como `JuicyPotato`, `RogueWinRM`, `PrintSpoofer`, etc., para escalar privilegios en un sistema objetivo.|
| `SeLoadDriverPrivilege`   | Este privilegio permite cargar y descargar drivers de dispositivos que podrían ser utilizados para escalar privilegios o comprometer un sistema.|
| `SeTakeOwnershipPrivilege`| Esto permite que un proceso tome posesión de un objeto. En su nivel más básico, podríamos usar este privilegio para acceder a una carpeta compartida o un archivo en una carpeta compartida que de otra manera no nos sería accesible. |

Tecnicas para explotar derechps:
> [Windows Privilege Abuse: Auditing, Detection, and Defense](https://blog.palantir.com/windows-privilege-abuse-auditing-detection-and-defense-3078a403d74e). 
> [HackTricks: Abusing Tokens](https://book.hacktricks.xyz/windows/windows-local-privilege-escalation/privilege-escalation-abusing-tokens).

### Viewing a User's Privileges

>  [User Account Control (UAC)](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works): Es un feature de seguridad de Windows que restringe las aplicaciones para que no se ejecuten con permisos completos a menos que sea absolutamente necesario.
  
#### Standard Domain User's Rights
```powershell
PS C:\htb> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== ========
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
```
  
#### Domain Admin Rights Non-Elevated
```powershell
PS C:\htb> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                          State
============================= ==================================== ========
SeShutdownPrivilege           Shut down the system                 Disabled
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled
SeUndockPrivilege             Remove computer from docking station Disabled
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled
SeTimeZonePrivilege           Change the time zone                 Disabled
```
  
#### Domain Admin Rights Elevated
```powershell
PS C:\htb> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                            Description                                                        State
========================================= ================================================================== ========
SeIncreaseQuotaPrivilege                  Adjust memory quotas for a process                                 Disabled
SeMachineAccountPrivilege                 Add workstations to domain                                         Disabled
SeSecurityPrivilege                       Manage auditing and security log                                   Disabled
SeTakeOwnershipPrivilege                  Take ownership of files or other objects                           Disabled
SeLoadDriverPrivilege                     Load and unload device drivers                                     Disabled
SeSystemProfilePrivilege                  Profile system performance                                         Disabled
SeSystemtimePrivilege                     Change the system time                                             Disabled
SeProfileSingleProcessPrivilege           Profile single process                                             Disabled
SeIncreaseBasePriorityPrivilege           Increase scheduling priority                                       Disabled
SeCreatePagefilePrivilege                 Create a pagefile                                                  Disabled
SeBackupPrivilege                         Back up files and directories                                      Disabled
SeRestorePrivilege                        Restore files and directories                                      Disabled
SeShutdownPrivilege                       Shut down the system                                               Disabled
SeDebugPrivilege                          Debug programs                                                     Enabled
SeSystemEnvironmentPrivilege              Modify firmware environment values                                 Disabled
SeChangeNotifyPrivilege                   Bypass traverse checking                                           Enabled
SeRemoteShutdownPrivilege                 Force shutdown from a remote system                                Disabled
SeUndockPrivilege                         Remove computer from docking station                               Disabled
SeEnableDelegationPrivilege               Enable computer and user accounts to be trusted for delegation     Disabled
SeManageVolumePrivilege                   Perform volume maintenance tasks                                   Disabled
SeImpersonatePrivilege                    Impersonate a client after authentication                          Enabled
SeCreateGlobalPrivilege                   Create global objects                                              Enabled
SeIncreaseWorkingSetPrivilege             Increase a process working set                                     Disabled
SeTimeZonePrivilege                       Change the time zone                                               Disabled
SeCreateSymbolicLinkPrivilege             Create symbolic links                                              Disabled
SeDelegateSessionUserImpersonatePrivilege Obtain an impersonation token for another user in the same session Disabled
```

#### Backup Operator Rights Non-Elevated
```powershell
PS C:\htb> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== ========
SeShutdownPrivilege           Shut down the system           Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
```

El right `SeBackupPrivilege` se obtiene en una terminal elevada ya que esta restricto por la `UAC`.

> Por lo general, es una buena práctica dejar la mayoría de estos grupos vacíos y agregar una cuenta a un grupo solo si se necesita realizar una acción única o configurar una tarea repetitiva. Cualquier cuenta agregada a uno de los grupos discutidos en esta sección o que se le otorguen privilegios adicionales debe ser estrictamente controlada y monitoreada, asignarle una contraseña o frase de acceso muy fuerte, y debe ser separada de una cuenta utilizada por un administrador del sistema para realizar sus tareas diarias.


## General Active Directory Hardening Measures

### LAPS
- [Microsoft Local Administrator Password Solution (LAPS)](https://www.microsoft.com/en-us/download/details.aspx?id=46899) se utiliza para aleatorizar y rotar las contraseñas de administrador local en hosts de Windows y prevenir el movimiento lateral. Las cuentas se pueden configurar para que su contraseña se rote en un intervalo fijo (es decir, 12 horas, 24 horas, etc.).

### Audit Policy Settings (Logging and Monitoring)

El registro y monitoreo efectivo se puede utilizar para detectar a un atacante o empleado no autorizado que agrega un usuario o una computadora, modifica un objeto en AD, cambia una contraseña de cuenta, accede a un sistema de manera no autorizada o no estándar, realiza un ataque como el "password spraying" o ataques más avanzados como los ataques modernos de Kerberos.

### Group Policy Security Settings

Las GPOs pueden ser usadas para aplicar una variedad de  [security policies](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/security-policy-settings) para ayudar en el harden del AD. A continuacion una lista no exsaustiva de algunas de ellas:

- [Account Policies](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/account-policies): Administra cómo interactúan las cuentas de usuario con el dominio.Incluye [Password Policy](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/password-policy), [Account Lockout Policy](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/account-lockout-policy), [Kerberos Policy](https://learn.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/kerberos-policy).

- [Local Policies](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/security-options): Se aplican a un host especificon. Entre estas estan las `security event audit policy`, asignacion de rights a usuarios y configuraciones de seguridad especificas como poder instalar drivers, habilitar la cuenta de administrador o guest y/o renombrarlas, evitar la instalacion de impresoras o medios extraibles entre otros. 

- [Software Restriction Policies](https://docs.microsoft.com/en-us/windows-server/identity/software-restriction-policies/software-restriction-policies):  Controlan que software se puede correr en un host.

- [Application Control Policies](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/windows-defender-application-control): Controlan que usuarios/grupos corren algunas aplicaciones. Generalmente se usa  [AppLocker](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/applocker-overview). Estas politicas pueden ser bypasseadas, pero son necesarias para una defensa en profundidad.

- [Advanced Audit Policy Configuration](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/secpol-advanced-security-audit-policy-settings): Variedad de configuraciones que se pueden ajustar para auditar actividades como el acceso o modificación de archivos, el inicio y cierre de sesión de cuentas, cambios de política, uso de privilegios y más.

Advanced Audit Policy
![[adv-audit-pol.png]]

### Update Management (SCCM/WSUS)
-  [Windows Server Update Service (WSUS)](https://docs.microsoft.com/en-us/windows-server/administration/windows-server-update-services/get-started/windows-server-update-services-wsus): Se puede instalar como en un Windows Server y se puede utilizar para automatizar el parcheo de los sistemas.
- `System Center Configuration Manager` (SCCM): Solucion de pago que necesita tener instalado `WSUS` y ofrece mas funcionalidades.

### Group Managed Service Accounts ([gMSA](https://learn.microsoft.com/es-es/windows-server/security/group-managed-service-accounts/group-managed-service-accounts-overview))
- Cuenta de dominio que se utiliza para proporcionar credenciales seguras para aplicaciones y servicios no interactivos que se ejecutan automáticamente en varios hosts.
- Contraseñas de 120 caracteres generada por el controlador de dominio. La contraseña se cambia a intervalos regulares y no necesita ser conocida por ningún usuario.

#### Otras Recomendaciones
- Los administradores deberian tener 2 cuentas, una para las tareas del dia a dia, otra solo para las tareas administrativas y ambas deben tener distintas contraseñas.
- Contraseñas de mas de 12 caracteres, recomendado frases como contraseñas.
- Utilizacion de 2FA tanto para uso administrativo como para conectarse por RDP.
- Usar las cuentas de Domain Admin solo para logear en el DC.
- Auditar periodicamente los usuarios y objetos y sus privilegios/permisos.
- Auditar periodicamente los permisos y accesos, permisos de local admin, cantidad de miembros en Domain Admins and Enterprise Admins.
- Auditar policies periodicamente.
- Loggear y crear reglas para detectar actividad anomala (como intentos de logins incorrectos, indicadores de Kerberoasting attack, AD enumeration). [Audit Policy Recommendations](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/audit-policy-recommendations) para ayudar a detectar indicadores de compromiso. 
- Usar [Restricted Groups](https://social.technet.microsoft.com/wiki/contents/articles/20402.active-directory-group-policy-restricted-groups.aspx).
- Limitar los roles en un servidor en especifico. Ej: No correr una aplicacion web en un servidor de Exchange, no instalar `Internet Information Service` (IIS) en el DC, tener las dbs separadas de las webapps...
- Limitar que usuarios necesitan local admin en que equipos en particular, esto se puede lograr mediante Restricted Groups. Es muy comun ver entornos donde muchos usuarios son local admin en uno o mas equipos.

>  [Best Practices for Securing Active Directory](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/best-practices-for-securing-active-directory)

## Examinando las Group Policy

### Group Policy Objects (GPOs)
- Las  [Group Policy Object (GPO)](https://docs.microsoft.com/en-us/previous-versions/windows/desktop/policy/group-policy-objects) son unas colecciones virtuales de varias GP aplicadas a un usuario, computadoras, OU, etc.
- Tienen un unico nombre y GUID.
- Puede ser linkeado a una OU, dominio o sitio.
- Una GPO puede ser aplicado a varios contenedores, un contenedor tambien puede tener aplicadas varias GPOs.
- Cada GPO contiene una o mas GP que pueden ser aplicadas a nivel local o en un contexto de AD.

### Ejemplos de GPOs

-   Establishing different password policies for service accounts, admin accounts, and standard user accounts using separate GPOs
-   Preventing the use of removable media devices (such as USB devices)
-   Enforcing a screensaver with a password
-   Restricting access to applications that a standard user may not need, such as cmd.exe and PowerShell
-   Enforcing audit and logging policies
-   Blocking users from running certain types of programs and scripts
-   Deploying software across a domain
-   Blocking users from installing unapproved software
-   Displaying a logon banner whenever a user logs into a system
-   Disallowing LM hash usage in the domain
-   Running scripts when computers start/shutdown or when a user logs in/out of their machine

#### RDP PGO Settings
![[rdp_gpo_settings.png]] 


### Orden de presedencia
| Nivel | Descripción |
| --- | --- |
| `Política de grupo local` | Las políticas se definen directamente en el host localmente fuera del dominio. Cualquier configuración aquí será sobrescrita si se define una configuración similar en un nivel superior. |
| `Política del sitio` | Cualquier política específica del sitio empresarial en el que reside el host. Un sitio puede tener sus propias políticas a seguir que podrían diferenciarlo del resto de la organización. Las políticas de control de acceso son un gran ejemplo de esto. Se Pueden especificar configuraciones a nivel de sitio y asegurarse de que estén vinculadas para que no sean sobrescritas por la política de dominio. Esta también es una excelente manera de realizar acciones como mapear impresoras y recursos compartidos para usuarios en sitios específicos. |
| `Política en toda la organización`| Cualquier configuración que desee aplicar en toda la organización.|
| `Unidad organizativa` (OU) | Estas configuraciones afectarían a los usuarios y computadoras que pertenecen a OUs específicas. Querría colocar aquí cualquier configuración única que sea específica del rol. Ej: Unidades compartidas para roles en especifico, el uso de cmd o powershell para los de IT, etc.|
| `Cualquier política de OU anidada dentro de otras OUs` | Las configuraciones en este nivel reflejarían permisos especiales para objetos dentro de OUs anidadas. Por ejemplo, proporcionar a los analistas de seguridad un conjunto específico de configuraciones de política de Applocker que difieren de las configuraciones estándar de Applocker de IT. |

- Se pueden gestionar las GP desde el Group Policy Management Console (GPMC), dentro de 'Administrative tools' en el menu de inicio en el DC. También se pueden gestionar por PowerShell usando el módulo [GroupPolicy](https://docs.microsoft.com/en-us/powershell/module/grouppolicy/?view=windowsserver2022-ps).

![[gpo_levels_precedence.png]]

**GPMC example**
![[gpmc_precedence_example.png]]

- Es posible setear la opción `Enforced`, así, una GP en una GPOs linkeada a una OU baja no puede sobreescribir la configuración.

**Enforced GPO Policy Precedence example**
![[gpo_enforced.png]]

- Es posible setear la opción `Block inheritance` a una OU. Las políticas de niveles superiores no son heredadas, ya sean de una OU superior o a nivel dominio.

En la imagen de abajo se puede observar que las GP heredadas de la OU Corp, ya no están en OU de computers, como así también la GP `Logon Banner` se conserva porque esta es `Enforced`, siendo que la otra GP a nivel dominio tampoco se heredó.

**Block Inheritance**
![[block_inheritance.png]]

### GP Refresh Frequency
- Para usuarios y ordenadores, es de 90 minutos con un offset de +/- 30 min.
- Para DCs, es de 5 minutos por default.
- Cuando se crea y linkea una nueva GPO, demora 120 min en hacer efecto.
- El offset de +/- 30 min es para que los clientes soliciten todos el update de las GPOs al mismo tiempo y sobrecarguen el DC y la red.
- Se puede forzar el update con el comando `gpupdate /force` desde un ordenador.
- Se puede modificar el intervalo de refresh dentro de la misma GP. `Computer Configuration --> Policies --> Administrative Templates --> System --> Group Policy -> Set Group Policy refresh interval for computers` 

![[refresh_gpo_updates.png]]


