## Active Directory Fundamentals
### Terminology And Glosary

**Object:**
- anywhere object of AD

**Attributes:**
- [attributes](https://docs.microsoft.com/en-us/windows/win32/adschema/attributes-all) associat object

**Schema:**
- El [schema](https://docs.microsoft.com/en-us/windows/win32/ad/schema) es la relacion que tienen los objetos y sus atributos en el AD.

**Dominio:**
- Es un agrupamiento logico, funciona como contenedor de los demas objetos por debajo de el.

**Forest:**
- Coleccion de trees (dominio) de AD

**Tree: **
- A domain...

**Container:**
- Objeto que contiene otros objetos, con un lugar definido en el jerarquia del subtree

**GUID:**
-  [GUID](https://docs.microsoft.com/en-us/windows/win32/adschema/a-objectguid)valor de 128 bits unico asignado al crear una instancia de algo. Es cross a todo el dominio, no se puede reutilizar una vez eliminado la instancia del objeto.
- se almacena en el atributo `ObjectGUID`.

**Security Principals: 
- [Security principals](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-principals) son entidades que pueden ser autenticadas por el SO, como cuentas de usuarios, cuentas, computer accounts, hilos o procesos.
- En AD son objetos del dominio que pueden otorgar acceso a otros recursos del dominio.

**Security Identifier (SID):**
-  SID is used as a unique identifier for a security principal or security group.
- Every account, group, or process has its own unique SID, which, in an AD environment, is issued by the domain controller and stored in a secure database. 
- A SID can only be used once in a enviroment.
- There are also [well-known SIDs](https://ldapwiki.com/wiki/Well-known%20Security%20Identifiers) that are used to identify generic users and groups.

**Distinguished Name (DN):**
- A [Distinguished Name (DN)](https://docs.microsoft.com/en-us/previous-versions/windows/desktop/ldap/distinguished-names) describes the full path to an object in AD (such as `cn=bjones, ou=IT, ou=Employees, dc=onedomain, dc=local`).

**Relative Distinguished Name (RDN):**
- A [Relative Distinguished Name (RDN)](https://docs.microsoft.com/en-us/windows/win32/ad/object-names-and-identities) is a single component of the Distinguished Name that identifies the object as unique from other objects at the current level in the naming hierarchy.
-  AD does not allow two objects with the same name under the same parent container.

**sAMAccountName:**
- The [sAMAccountName](https://docs.microsoft.com/en-us/windows/win32/ad/naming-properties#samaccountname) is the user's logon name. Here it would just be `bjones`. It must be a unique value and 20 or fewer characters.

**userPrincipalName:**
- The [userPrincipalName](https://social.technet.microsoft.com/wiki/contents/articles/52250.active-directory-user-principal-name.aspx) attribute is another way to identify users in AD. `bjones@inlanefreight.local`
- This attribute is not mandatory.

**FSMO Roles**:
-  [Flexible Single Master Operation (FSMO)](https://docs.microsoft.com/en-us/troubleshoot/windows-server/identity/fsmo-roles) roles give DC the ability to continue authenticating users and granting permissions whiout interruption. 
- There are five FMSO roles: 
	- `Schema Master` and `Domain Naming Master` (one of each per forest)
	- `Relative ID (RID) Master` (one per domain), `Primary Domain Controller (PDC) Emulator` (one per domain), and `Infrastructure Master` (one per domain).
- All five roles are assigned to the first DC in the forest root domain in a new AD forest

**Global Catalog**:
- The [global catalog (GC)](https://docs.microsoft.com/en-us/windows/win32/ad/global-catalog) stores a full copy of all objects in the current domain and a partial copy of objects that belong to other domains in the forest.
- GC is a feature that is enabled on a domain controller and performs the following functions:
	- **Authentication** (provided authorization for all groups that a user account belongs to, which is included when an access token is generated)
	- **Object search** (making the directory structure within a forest transparent, allowing a search to be carried out across all domains in a forest by providing just one attribute about an object.)

**Read-Only Domain Controller (RODC):**

Duda: si se usa [RODC filtered attribute set](https://learn.microsoft.com/en-us/windows/win32/ad/rodc-and-active-directory-schema#rodc-filtered-attribute-set) sobre credenciales, password o keys. como se puede logear de manera offline en este rodc local?

- A [RODC](https://docs.microsoft.com/en-us/windows/win32/ad/rodc-and-active-directory-schema) has a read-only Active Directory database.
- Is used in branch offices where a full domain controler cannot be placed.
- Allow users to perform logon and task like print/share file even when there is no network connectivity to hub sites.
- attribute  `RODC filtered`: prevent replicating to RODCs in the forest.

**Replication:**
- [Replication](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/replication/active-directory-replication-concepts) happens in AD when AD objects are updated and transferred from one Domain Controller to another.
- Whenever a DC is added, connection objects are created to manage replication between them. These connections are made by the Knowledge Consistency Checker (KCC) service, which is present on all DCs.

**Connection object:**
- A [connection object](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/get-started/replication/active-directory-replication-concepts#BKMK_1) is an Active Directory object that represents a replication connection from a source domain controller to a destination domain controller.

**Service Principal Name (SPN)**
- A [Service Principal Name (SPN)](https://docs.microsoft.com/en-us/windows/win32/ad/service-principal-names) uniquely identifies a service instance. They are used by Kerberos authentication to associate an instance of a service with a logon account, allowing a client application to request the service to authenticate an account without needing to know the account name.

**Group Policy Object (GPO):**
- [Group Policy Objects (GPOs)](https://docs.microsoft.com/en-us/previous-versions/windows/desktop/policy/group-policy-objects) are virtual collections of policy settings. Each GPO has a unique GUID. 
- A GPO can contain local file system settings or Active Directory settings.
- GPO settings can be applied to both user and computer objects. They can be applied to all users and computers within the domain or defined more granularly at the OU level.

**Access Control List (ACL):**
- An [Access Control List (ACL)](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-control-lists) is the ordered collection of Access Control Entities (ACEs) that apply to an object.

**Access Control Entities (ACEs):**
- Each [Access Control Entity (ACE)](https://docs.microsoft.com/en-us/windows/win32/secauthz/access-control-entries) in an ACL identifies a trustee (user account, group account, or logon session) and lists the access rights that are allowed, denied, or audited for the given trustee.

**Discretionary Access Control List (DACL):**

- DACLs define which security principles are granted or denied access to an object; it contains a list of ACEs. 
- When a process tries to access a securable object, the system checks the ACEs in the object's DACL to determine whether or not to grant access. 
- If an object does NOT have a DACL, then the system will grant full access to everyone, but if the DACL has no ACE entries, the system will deny all access attempts. 
- ACEs in the DACL are checked in sequence until a match is found that allows the requested rights or until access is denied.

**Fully Qualified Domain Name (FQDN):**
- An FQDN is the complete name for a specific computer or host. It is written with the hostname and domain name in the format `[host name].[domain name].[tld]`
- example: 
	- Host: `DC01`, Domain: `ONEDOMAIN.LOCAL`
	- FQDN: `DC01.ONEDOMAIN.LOCAL`

**Tombstone**
- A [tombstone](https://ldapwiki.com/wiki/Tombstone) is a container object in AD that holds deleted AD objects, like a 'Recycle Bin' but not preserve attributes of then
- When an object is deleted from AD, the object remains for a set period of time known as the `Tombstone Lifetime,` and the `isDeleted` attribute is set to `TRUE`.
- Once an object exceeds the `Tombstone Lifetime`, it will be entirely removed.

**AD Recycle Bin:**
- When the AD Recycle Bin is enabled, any deleted objects are preserved for a period of time, facilitating restoration if needed.
- The [AD Recycle Bin](https://techcommunity.microsoft.com/t5/ask-the-directory-services-team/the-ad-recycle-bin-understanding-implementing-best-practices-and/ba-p/396944) is other container object in AD that holds deleted AD objects and those attributes are preserved.

**SYSVOL:**
- The [SYSVOL](https://social.technet.microsoft.com/wiki/contents/articles/8548.active-directory-sysvol-and-netlogon.aspx) folder, or share, stores copies of public files in the domain such as system policies, Group Policy settings, logon/logoff scripts, and often contains other types of scripts that are executed to perform various tasks in the AD environment.
- The contents of the SYSVOL folder are replicated to all DCs within the environment using File Replication Services (FRS). You can read more about the SYSVOL structure [here](http://www.techiebird.com/Sysvol_structure.html).

**AdminSDHolder:**
- The [AdminSDHolder](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory) object is used to manage ACLs for members of built-in groups in AD marked as privileged. It acts as a container that holds the Security Descriptor applied to members of protected groups.
- AdminSDHolder is automatically created as an object in the System container of every Active Directory domain. Its path is: **CN=AdminSDHolder,CN=System,DC=<domain_component>,DC=<domain_component>?.**
- Unlike most objects in the Active Directory domain, which are owned by the Administrators group, AdminSDHolder is owned by the Domain Admins group.

**SDProp:**
- [SDProp](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory#sdprop) is a process that runs every 60 minutes (by default) on the domain controller that holds the domain's PDC Emulator (PDCE). SDProp compares the permissions on the domain's AdminSDHolder object with the permissions on the protected accounts and groups in the domain. If the permissions on any of the protected accounts and groups do not match the permissions on the AdminSDHolder object, the permissions on the protected accounts and groups are reset to match those of the domain's AdminSDHolder object.

**dsHeuristics:**
- The [dsHuerisitcs](https://docs.microsoft.com/en-us/windows/win32/adschema/a-dsheuristics) attribute is a string value set on the Directory Service object used to define multiple forest-wide configuration settings. 
- One of these settings is to exclude built-in groups from the [Protected Groups](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory) list. Groups in this list are protected from modification via the `AdminSDHolder` object. If a group is excluded via the `dsHeuristics` attribute, then any changes that affect it will not be reverted when the SDProp process runs.

**adminCount:**
The [adminCount](https://docs.microsoft.com/en-us/windows/win32/adschema/a-admincount) attribute determines whether or not the SDProp process protects a user. If the value is set to `0` or not specified, the user is not protected. If the attribute value is set to `value`, the user is protected. Attackers will often look for accounts with the `adminCount` attribute set to `1` to target in an internal environment. These are often privileged accounts and may lead to further access or full domain compromise.

**Active Directory Users and Computers (ADUC):**
ADUC is a GUI console commonly used for managing users, groups, computers, and contacts in AD. Changes made in ADUC can be done via PowerShell as well.

**ADSI Edit:**
ADSI Edit is a GUI tool used to manage objects in AD. It provides access to far more than is available in ADUC and can be used to set or delete any attribute available on an object, add, remove, and move objects as well. It is a powerful tool that allows a user to access AD at a much deeper level. Great care should be taken when using this tool, as changes here could cause major problems in AD.

**sIDHistory:**
- [This](https://docs.microsoft.com/en-us/defender-for-identity/cas-isp-unsecure-sid-history-attribute) attribute holds any SIDs that an object was assigned previously. It is usually used in migrations so a user can maintain the same level of access when migrated from one domain to another. 
- This attribute can potentially be abused if set insecurely, allowing **an attacker to gain prior elevated access that an account had before a migration if SID Filtering** (or removing SIDs from another domain from a user's access token that could be used for elevated access) **is not enabled.**

**NTDS.DIT:**
- The NTDS.DIT file can be considered the heart of Active Directory. It is stored on a Domain Controller at `C:\Windows\NTDS\` and is a database that stores AD data such as information about user and group objects, group membership, and **the password hashes for all users in the domain.** 
- Once full domain compromise is reached, an attacker can retrieve this file, extract the hashes, and either use them to perform a pass-the-hash attack or crack them offline using a tool such as Hashcat to access additional resources in the domain. If the setting [Store password with reversible encryption](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) is enabled, then the NTDS.DIT will also store the cleartext passwords for all users created or who changed their password after this policy was set. While rare, some organizations may enable this setting if they use applications or protocols that need to use a user's existing password (and not Kerberos) for authentication.


### AD Objects

**Users:**
- Leaf objects.
- Is a security principal -> have a security identifier **(SID) and global unique indentifier (GUID)**
- Have a lot of possibles attributes
- They are a crucial target for attackers since gaining access to even a low privileged user can grant access to many objects and resources and allow for detailed enumeration of the entire domain (or forest).

**Contacts:**
- Leaf objects
- Are not security principals, don´t have SID, **only GUID**.
- Attributes such as first name, last name, email address, telephone number, etc.

**Printers:**
- Leaf objects.
- Only **have GUID**.
- Attributes such as the printer's name, driver information, port number, etc.

**Computers:**
- Leaf objects.
- Are security principal and **have SID and GUID**.
- Like users, they are prime targets for attackers since full administrative access to a computer (as the all-powerful `NT AUTHORITY\SYSTEM` account) grants similar rights to a standard domain user and can be used to perform the majority of the enumeration tasks that a user account can (save for a few exceptions across domain trusts.)

**Shared Folders:**
- A shared folder object points to a shared folder on the specific computer where the folder resides.
- have stringent access control:
	- applied to them and can be either accessible to everyone
	- open to only authenticated users
	- or be locked down to only allow certain users/groups access.
	- Anyone not explicitly allowed access will be denied from listing or reading its contents.
	- have only GUID

**Groups:**
- Considered a container object because it can contain other objects, including users, computers and even other groups.
- Is a security principal -> have SID and GUID.
- We commonly see what are called "[nested groups](https://docs.microsoft.com/en-us/windows/win32/ad/nesting-a-group-in-another-group)"  which can lead to a user(s) obtaining unintended rights.
- **Nested group membership is something we see and often leverage during penetration tests.** The tool [BloodHound](https://github.com/BloodHoundAD/BloodHound) helps to discover attack paths within a network and illustrate them in a graphical interface

**Organizational Units:**
- An OU is a container that systems administrators can use to store similar objects for ease of administration. (like inheritance).
- OUs are very useful for managing Group Policy settings across a subset of users and groups within a domain.
- An OU can have multiple OUs within it, but all attributes within the containing OU must be unique.

**Domain**:
- A domain is the structure of an AD network. Domains contain objects such as users and computers, which are organized into container objects: groups and OUs. 
- Every domain has its own separate database and sets of policies that can be applied to any and all objects within the domain.

**Domain Controller:**
- Domain Controllers are essentially the brains of an AD network. 
- They handle authentication requests, verify users on the network, and control who can access the various resources in the domain. 
- All access requests are validated via the domain controller and privileged access requests are based on predetermined roles assigned to users. 
- It also enforces security policies and stores information about every other object in the domain.


**Sites:**
- A site in AD is a set of computers across one or more subnets connected using high-speed links. They are used to make replication across domain controllers run efficiently.

 **Built-in:**
- In AD, built-in is a container that holds [default groups](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups) in an AD domain. They are predefined when an AD domain is created.

**Foreign Security Principals:**
- A foreign security principal (FSP) is an object created in AD to represent a security principal that belongs to a trusted external forest. 
- They are created when an object such as a user, group, or computer from an external (outside of the current) forest is added to a group in the current domain. 
- They are created automatically after adding a security principal to a group. 
- Every foreign security principal is a placeholder object that holds the SID of the foreign object (an object that belongs to another forest.) Windows uses this SID to resolve the object's name via the trust relationship. FSPs are created in a specific container named ForeignSecurityPrincipals with a distinguished name like `cn=ForeignSecurityPrincipals,dc=onadomain,dc=local`.

### AD Functionality

Flexible Single Master Operation [FSMO](https://www.lepide.com/blog/5-fsmo-roles-active-directory/) roles.


| **Roles** | **Description** |
| --------------|-------------------|
|`Schema Master` |This role manages the read/write copy of the AD schema, which defines all attributes that can apply to an object in AD. |
| `Domain Naming Master` | Manages domain names and ensures that two domains of the same name are not created in the same forest. |
| `Relative ID (RID) Master` | The RID Master assigns blocks of RIDs to other DCs within the domain that can be used for new objects. The RID Master helps ensure that multiple objects are not assigned the same SID. Domain object SIDs are the domain SID combined with the RID number assigned to the object to make the unique SID.
| `PDC Emulator` | The host with this role would be the authoritative DC in the domain and respond to authentication requests, password changes, and manage Group Policy Objects (GPOs). The PDC Emulator also maintains time within the domain. |
| `Infrastructure Master` | This role translates GUIDs, SIDs, and DNs between domains. This role is used in organizations with multiple domains in a single forest. The Infrastructure Master helps them to communicate. If this role is not functioning properly, Access Control Lists (ACLs) will show SIDs instead of fully resolved names. |

**Domain and Forest Functional Levels:**

- Microsoft introduced functional levels to determine the various features and capabilities available in Active Directory Domain Services (AD DS) at the domain and forest level.

**Trust:**
- A trust is used to establish `forest-forest` or `domain-domain` authentication, allowing users to access resources in (or administer) another domain outside of the domain their account resides in. A trust creates a link between the authentication systems of two domains.
- Trust can be transitive or non-transitive:
	- Transitive: A transitive trust means that trust is extended to objects that the child domain trusts.
	- Non-transitive: In a non-transitive trust, only the child domain itself is trusted.
- Trust can be one-way or two-way directional:
	- one-way: In a one-way trust, only users in a trusted domain can access resources in a trusting domain, not vice-versa. The direction of trust is opposite to the direction of access.
	- two-way: In bidirectional trusts, users from both trusting domains can access resources.

| **Trust Type** | **Description** |
| --------------|-------------------|
| `Parent-child` | Domains within the same forest. The child domain has a two-way transitive trust with the parent domain. | 
| `Cross-link` | a trust between child domains to speed up authentication.
| `External` | A non-transitive trust between two separate domains in separate forests which are not already joined by a forest trust. This type of trust utilizes SID filtering. |
| `Tree-root` | a two-way transitive trust between a forest root domain and a new tree root domain. They are created by design when you set up a new tree root domain within a forest. |
| `Forest` | a transitive trust between two forest root domains. |


## AD Protocols

**Kerberos:**


**DNS:**
- AD DS use DNS to allow clients to locate DC and for DC that host the directory service to comunicate amongst themselves.
- Private internal networks use AD DNS namespaces to facilitate communications between servers, clients, and peers.
- AD maintains a db of services running on the network in the form of service records (SRV). The service records allow clients in an AD to locate service that they need such as file server, printer or DC.
- Use TCP and UDP port 53. UDP port 53 is the default, but is falls, use TCP.

**Forward DNS Lookup:**

We can perform a `nslookup` for the domain name and retrieve all Domain Controllers' IP addresses in a domain.
```powershell
nslookup INLANEFREIGHT.LOCAL

Server:  172.16.6.5
Address:  172.16.6.5

Name:    INLANEFREIGHT.LOCAL
Address:  172.16.6.5
```

**Reverse DNS Lookup:**
If we would like to obtain the DNS name of a single host using the IP address, we can do this as follows:

```powershell
nslookup 172.16.6.5

Server:  172.16.6.5
Address:  172.16.6.5

Name:    ACADEMY-EA-DC01.INLANEFREIGHT.LOCAL
Address:  172.16.6.5
```


**LDAP:**
- LDAP is an open-source and cross-platform protocol used for authentication against various directory services (such as AD).
- The latest LDAP specification is [Version 3](https://tools.ietf.org/html/rfc4511), published as RFC 4511.
- LDAP uses port 389, and LDAP over SSL (LDAPS) communicates over port 636.
- LDAP is the language that applications use to communicate with other servers that provide directory services.
- An LDAP session begins by first connecting to an LDAP server, also known as a Directory System Agent. The Domain Controller in AD actively listens for LDAP requests, such as security authentication requests.
- The relationship between AD and LDAP can be compared to Apache and HTTP. The same way Apache is a web server that uses the HTTP protocol, Active Directory is a directory server that uses the LDAP protocol.