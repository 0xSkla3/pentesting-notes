# Introduccion a Windows

Esta guia se realiza con la idea de poder dejar como referencia para cualquiera que quiera introducirse en la seguridad ofensiva hacia sistemas Windows. Antes de poder encarar temas como escalada de privilegios o escritura de exploits, se tiene que tener idea sobre la administracion del mismo, he aqui el porque de comenzar por lo que denomine los _essentials_.

## Un poco de historia

Microsoft presentó por primera vez el sistema operativo Windows el 20 de noviembre de 1985. La primera versión de Windows era un sistema operativo gráfico para MS-DOS. Las versiones posteriores de Windows Desktop introdujeron los programas Windows File Manager, Program Manager y Print Manager.

Windows 95 fue la primera integración completa de Windows y DOS y ofreció por primera vez soporte incorporado para Internet. Esta versión también estrenó el navegador web Internet Explorer. Desde la versión inicial, se han lanzado más de una docena de versiones de Windows, como Windows XP, Vista y 8, hasta la versión actual: Windows 10. A lo largo del tiempo, Microsoft ha ofrecido varias ediciones de cada versión de Windows Desktop para satisfacer a todos, desde los consumidores ocasionales hasta los clientes empresariales.

Windows Server se lanzó por primera vez en 1993 con el lanzamiento de Windows NT 3.1 Advanced Server. Windows NT fue objeto de varias actualizaciones a lo largo de los años, añadiendo tecnologías como Internet Information Services (IIS), varios protocolos de red, asistentes administrativos para facilitar las tareas de administración, etc. Con el lanzamiento de Windows 2000, Microsoft estrenó Active Directory, originalmente destinado a ayudar a los administradores de sistemas a configurar el uso compartido de archivos, el cifrado de datos, las VPN, etc. Windows Server 2000 también incluía la consola de gestión de Microsoft (MMC) y admitía volúmenes de disco dinámicos.

Windows Server 2003 vino después con roles de servidor, un cortafuegos integrado, el servicio Volume Shadow Copy, etc. Windows Server 2008 incluía failover clustering, software de virtualización Hyper-V, Server Core, Event Viewer e importantes mejoras en Active Directory. A lo largo de los años, Microsoft lanzó más versiones de Server, incluyendo Server 2012, Server 2016 y, más recientemente, Server 2019. Esta última versión añadió soporte para Kubernetes, contenedores de Linux y características de seguridad más avanzadas.

A medida que se introducen nuevas versiones de Windows, las versiones anteriores quedan obsoletas y dejan de recibir actualizaciones de Microsoft (a menos que se adquiera un contrato de soporte a largo plazo en algunos casos). Windows Server 2008 y 2012 llegaron al final de su vida útil para las actualizaciones de seguridad el 14 de enero de 2020. Actualmente, solo Server 2012 R2 y posteriores están en soporte. Sin embargo, Microsoft ha lanzado parches fuera de banda para versiones anteriores de Windows en los últimos años debido al descubrimiento de la vulnerabilidad crítica SMBv1 (EternalBlue).

Muchas versiones de Windows se consideran ahora "legacy" y ya no reciben soporte. Las organizaciones a menudo se encuentran ejecutando varios sistemas operativos antiguos para dar soporte a aplicaciones críticas o debido a preocupaciones operativas o presupuestarias. Un investigador debe comprender las diferencias entre las versiones y los diversos errores de configuración y vulnerabilidades inherentes a cada una de ellas.

### Tipos de accesos

Hay 2 formas de acceder a un sistema, de manera local o fisica y de manera remota.
Entre las tecnologias para tener accesos de forma remota tenemos:

-   Virtual Private Networks (VPN)
-   Secure Shell (SSH)
-   File Transfer Protocol (FTP)
-   Virtual Network Computing (VNC)
-   Windows Remote Management (or PowerShell Remoting) (WinRM)
-   Remote Desktop Protocol (RDP)

#### Remote Desktop Protocol (RDP)

RDP utiliza una arquitectura cliente/servidor en la que se utiliza una aplicación del lado del cliente para especificar la dirección IP o el nombre de host de un ordenador de destino a través de una red en la que está habilitado el acceso RDP. El ordenador de destino donde se habilita el acceso remoto RDP se considera el servidor. Es importante tener en cuenta que RDP escucha por defecto en el puerto lógico 3389.  Para que esto funcione, el acceso remoto debe estar ya [habilitado](https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/remote-desktop-allow-access) en el sistema Windows de destino. Por defecto, el acceso remoto no está permitido en los sistemas operativos Windows. Los archivos con extención `.rdp` pueden contener la configuración de una conexion remota.

Para conexiones entre 2 maquinas objetivos podemos utilizar la aplicación  `Remote Desktop Connection` ([mstsc.exe](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/mstsc))
Para conexiones entre una maquina linux y una windows podemos usar [xfreerdp](https://linux.die.net/man/1/xfreerdp)

```bash
xfreerdp /v:<targetIp> /u:<user> /p:<pwd>
```

### cmd vs powershell

La principal diferencia entre ambos es que **PowerShell permite una programación orientada a objetos**.  Estos pueden ser los [cmdlet](https://docs.microsoft.com/en-us/powershell/scripting/developer/cmdlet/cmdlet-overview?view=powershell-7) que son comandos livianos que se usan en entornos de PowerShell. los cmdlets tienen la forma de `Verbo-Sustantivo`. Por ejemplo, el comando  `Get-ChildItem` puede usarse para darnos una lista del contenido del directorio actual. los cmdlets tambien puede recibir argumentos o flags. Podemos escribir `Get-ChildItem -` y pulsar la tecla de tabulación para iterar a través de los argumentos.

#### Aliases

Muchos cmdlets en PowerShell también tienen alias. Por ejemplo, los alias del cmdlet `Set-Location`, para cambiar los directorios, son `cd` o `sl`. Mientras tanto, los alias para `Get-ChildItem` son `ls` y `gci`. Podemos ver todos los alias disponibles escribiendo `Get-Alias`.



```powershell
PS C:\skla3> New-Alias -Name "Show-Files" Get-ChildItem
PS C:\> Get-Alias -Name "Show-Files"

CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Alias           Show-Files
```

```powershell
PS C:\Users\skla3> Get-Alias | findstr ipconfig
Alias           ifconfig -> ipconfig.exe
```

[Get-WmiObject](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-wmiobject?view=powershell-5.1): Gets instances of Windows Management Instrumentation WMI, es un cmdlet
win32_OperatingSystem: is a class
other interesting classes: `Win32_Process, Win32_Service Win32_Bios

```powershell
PS C:\skla3> Get-WmiObject -Class win32_OperatingSystem | select Version,BuildNumber

Version    BuildNumber
-------    -----------
10.0.19041 19041
```


## Estructura del Sistema Operativo

En los sistemas operativos Windows, el directorio raíz es <letra_de_la_unidad>:\\(comúnmente la unidad C). El directorio raíz (también conocido como la partición de arranque) es donde se instala el sistema operativo. A otras unidades físicas y virtuales se les asignan otras letras, por ejemplo, Datos (E:). La estructura de directorios de la partición de arranque es la siguiente:

| **Directory** | **Function** |
| --------------|-------------------|
| Perflogs | Puede contener los registros de rendimiento de Windows, pero está vacío por defecto. |
| Program Files | En los sistemas de 32 bits, todos los programas de 16 y 32 bits se instalan aquí. En los sistemas de 64 bits, sólo se instalan aquí los programas de 64 bits. |
| Program Files (x86) | Los programas de 32 y 16 bits son installados aca en ediciones de Windows de 64-bits. |
| ProgramData | Esta es una carpeta oculta que contiene datos que son escenciales para ciertos programas que estan corriendo | 
| Users | Esta carpeta contiene los perfiles de los usuarios que se conectan al sistema, ademas de las carpetas Public y Default | 
| Default | Este es la plantilla de perfil por defecto que se usa cuando se crea un nuevo usuario en el sistema. |
| Public | Esta carpeta esta pensada para que los usuarios compartan archivos y sea accesible por todos los usuarios por default. Ademas  se comparte a través de la red por defecto, pero requiere una cuenta de red válida para acceder a ella.
| AppData | Por usuarios, los datos de aplicaciones de usuario y sus configuraciones son guardadas en subcarpetas ocultas, por ejemplo user/AppData. Por cada uno de estas subcarpetas pertenecientes al usuario, hay 3 subcarpetas más llamadas Roaming, Local y LocalLow. La carpeta Roaming contiene datos independientes de la máquina que deben seguir el perfil del usuario, como los diccionarios personalizados. La carpeta Local es específica del propio ordenador y nunca se sincroniza en la red. LocalLow es similar a la carpeta Local, pero tiene un nivel de integridad de datos más bajo. Por lo tanto, puede ser utilizada, por ejemplo, por un navegador web configurado en modo protegido o seguro. |
| Windows | La mayoria de los archivos requeridos por el sistema operativo estan almacenados acá. |
| System, System32, SysWOW64 | Contiene todos los ddll requeridos por el las funcionalidades conre de Windows y la Windows API. El sistema operativo busca en estas carpetas cada vez que un programa pide cargar una DLL sin especificar la ruta absoluta. |
| WinSxS | La tienda de componentes de Windows contiene una copia de todos los componentes, actualizaciones y paquetes de servicio de Windows. |


## File System

Hay 5 tipos de sistemas de archivos de Windows: FAT12, FAT16, FAT32, NTFS y exFAT. FAT12 y FAT16 ya no se utilizan en los sistemas operativos Windows modernos. FAT12, FAT16, FAT32, [NTFS](https://www.ntfs.com/index.html) y exFAT. FAT12 y FAT16 ya no se utilizan en los sistemas operativos Windows modernos. 

FAT32 (File Allocation Table) se utiliza ampliamente en muchos tipos de dispositivos de almacenamiento, como memorias USB y tarjetas SD, pero también puede utilizarse para formatear discos duros. El "32" del nombre se refiere al hecho de que FAT32 utiliza 32 bits de datos para identificar grupos de datos en un dispositivo de almacenamiento.

Ventajas de FAT32:

- Compatibilidad con dispositivos: se puede utilizar en ordenadores, cámaras digitales, consolas de juegos, smartphones, tabletas, etc.
- Compatibilidad cruzada con sistemas operativos: funciona en todos los sistemas operativos Windows a partir de Windows 95 y también es compatible con MacOS y Linux.

Desvenjatas: 

- Sólo se puede utilizar con archivos de menos de 4 GB.
- No incorpora funciones de protección de datos ni de compresión de archivos.
- Debe utilizar herramientas de terceros para el cifrado de archivos.

NTFS (New Technology File System) es el sistema de archivos por defecto de Windows desde Windows NT 3.1. Además de compensar las deficiencias de FAT32, NTFS también tiene un mejor soporte para los metadatos y un mejor rendimiento gracias a una mejor estructuración de los datos.

Ventajas de NTFS:

- NTFS es fiable y puede restaurar la consistencia del sistema de archivos en caso de fallo del sistema o pérdida de energía.
- Proporciona seguridad al permitirnos establecer permisos granulares tanto en los archivos como en las carpetas.
- Admite particiones de gran tamaño.
- Tiene incorporado el registro en el diario, lo que significa que las modificaciones de los archivos (adición, modificación, eliminación) se registran.

Desventajas:

- La mayoría de los dispositivos móviles no soportan NTFS de forma nativa.
- Los dispositivos multimedia más antiguos, como los televisores y las cámaras digitales, no ofrecen soporte para dispositivos de almacenamiento NTFS.

#### Permisos Basicos de NTFS

Los [Permisos basicos](https://www.ntfs.com/ntfs-permissions-file-folder.htm) se agrupan para facilitar la asignación de permisos complementarios a los usuarios. Estos grupos se denominan permisos "básicos". La siguiente tabla muestra cómo se asignan los permisos básicos en cada caso.

| **Permission** | **Description** |
| --------------|-------------------|
| `Basic Full Control` | Los usuarios pueden añadir, editar, mover y eliminar archivos y carpetas, así como cambiar los permisos NTFS que se aplican a todas las carpetas permitidas. |
| `Basic Modify` | A los usuarios se les permite o deniega los permisos para ver y modificar archivos y carpetas. Esto incluye añadir o eliminar archivos. |
| `Basic Read & Execute` |  Los usuarios tienen permiso o no para leer el contenido de los archivos y ejecutar programas. |
| `Basic List folder contents` | Los usuarios tienen permisos permitidos o denegados para ver un listado de archivos y subcarpetas. |
| `Basic Read` | Los usuarios tienen permiso o no para leer el contenido de los archivos. |
| `Basic Write` | Los usuarios tienen permisos permitidos o denegados para escribir cambios en un archivo y añadir nuevos archivos a una carpeta. |
| `Special Permissions` | Una variedad de opciones de permisos avanzados. |

![[Pasted image 20221116221539.png]]

#### Permisos especiales NTFS 

Los [Permisos especiales](https://www.ntfs.com/ntfs-permissions-file-advanced.htm) que se pueden establecer en las carpetas y archivos dependen de la forma en que se accede a un objeto.
La razón por la que estos permisos se denominan permisos "avanzados" es porque aparecen en el cuadro de diálogo Configuración de seguridad avanzada. Para acceder a ellos, debe hacer clic en el botón Avanzado del cuadro de diálogo Propiedades, pestaña Seguridad.

| **Permission** | **Description** |
| --------------|-------------------|
| `Full control` | Users are permitted or denied permissions to add, edit, move, delete files & folders as well as change NTFS permissions that apply to all permitted folders |
| `Traverse folder / execute file` | A los usuarios se les permite o se les deniega el permiso para acceder a una subcarpeta dentro de una estructura de directorios, incluso si al usuario se le deniega el acceso a los contenidos en el nivel de la carpeta principal. También se puede permitir o denegar a los usuarios los permisos para ejecutar programa. ||
| `List folder/read data` | A los usuarios se les permite o se les niega el permiso para ver los archivos y carpetas contenidos en la carpeta principal. También se puede permitir a los usuarios abrir y ver los archivos. |
| `Read attributes` | Los usuarios tienen permisos permitidos o denegados para ver los atributos básicos de un archivo o carpeta. Ejemplos de atributos básicos: sistema, archivo, sólo lectura y oculto. |
| `Read extended attributes`  | A los usuarios se les permite o se les niega el permiso para ver los atributos extendidos de un archivo o carpeta. Los atributos difieren según el programa. |
| `Create files/write data` | Los usuarios tienen permisos permitidos o denegados para crear archivos dentro de una carpeta y realizar cambios en un archivo. |
| `Create folders/append data` | A los usuarios se les permite o deniega los permisos para crear subcarpetas dentro de una carpeta. Se pueden añadir datos a los archivos, pero no se puede sobrescribir el contenido preexistente. |
| `Write attributes` | Se permite o se deniega a los usuarios la modificación de los atributos de los archivos. Este permiso no concede acceso a la creación de archivos o carpetas. |
| `Write extended attributes` | A los usuarios se les permite o se les niega el permiso para cambiar los atributos extendidos en un archivo o carpeta. Los atributos difieren según el programa. |
| `Delete subfolders and files` | A los usuarios se les permite o se les niega el permiso para eliminar subcarpetas y archivos. Las carpetas principales no se eliminarán. |
| `Delete` | A los usuarios se les permite o se les deniega el permiso para eliminar carpetas, subcarpetas y archivos principales. |
| `Read permissions` | Los usuarios tienen permitidos o denegados los permisos de lectura de una carpeta. |
| `Change permissions` | Los usuarios tienen permiso o no para cambiar los permisos de un archivo o carpeta. |
| `Take ownership` | A los usuarios se les permite o se les niega el permiso para tomar posesión de un archivo o carpeta. El propietario de un archivo tiene permisos completos para cambiar cualquier permiso. |

Los archivos y carpetas heredan los permisos NTFS de su carpeta padre para facilitar la administración, por lo que los administradores no necesitan establecer explícitamente los permisos para cada archivo y carpeta, ya que esto llevaría mucho tiempo. Si es necesario establecer los permisos explícitamente, un administrador puede desactivar la herencia de permisos para los archivos y carpetas necesarios y luego establecer los permisos directamente en cada uno.

#### Integrity Control Access Control List (icacls)

Los permisos sobre carpetas y archivos en el filesystem NTFS puede ser administrados a travez bajo la pestaña de seguridad del File Explorer GUI. Ademas de la GUI, tambien se pueden administrar con una mejor granularidad los permisos NTFS a travez del aplicativo [icacls](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/icacls).

```powershell
C:\sadosky> icacls c:\windows
c:\windows NT SERVICE\TrustedInstaller:(F)
           NT SERVICE\TrustedInstaller:(CI)(IO)(F)
           NT AUTHORITY\SYSTEM:(M)
           NT AUTHORITY\SYSTEM:(OI)(CI)(IO)(F)
           BUILTIN\Administrators:(M)
           BUILTIN\Administrators:(OI)(CI)(IO)(F)
           BUILTIN\Users:(RX)
           BUILTIN\Users:(OI)(CI)(IO)(GR,GE)
           CREATOR OWNER:(OI)(CI)(IO)(F)
           APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(RX)
           APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(OI)(CI)(IO)(GR,GE)
           APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(RX)
           APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files
```

En el output anterior podemos ver un listado donde primero aparece el usuario con los permisos y debajo aparece el mismo usuario con los niveles de acceso a los recursos. Las posibles configuraciones de herencia son:

- (`CI`, container inherit): herencia del contenedor
- (`OI`, object inherit): heredar objeto
- (`IO`, only inherit): heredar sólo
- (`NP`, no propage): no propagar la herencia
- (`I`, inherit): permiso heredado del contenedor padre

En el ejemplo anterior, la cuenta `NT AUTHORITY\SYSTEM` tiene permisos de herencia de objetos (`OI`), herencia de contenedores (`CI`), sólo herencia (`IO`) y acceso total (`F`). Esto significa que esta cuenta tiene control total sobre todos los objetos del sistema de archivos en este directorio y subdirectorios.

Los permisos de acceso básicos son los siguientes:

- `F` : acceso total
- `D` : acceso de supresión
- `N` : sin acceso
- `M` : acceso de modificación
- `RX` : acceso de lectura y ejecución
- `R` : acceso de sólo lectura
- `W` : acceso de sólo escritura

Podemos añadir y eliminar permisos a través de la línea de comandos utilizando `icacls`. Aquí estamos ejecutando icacls en el contexto de una cuenta de administrador local mostrando el directorio `C:\users` donde el usuario `pepe` no tiene permisos de escritura.

```powershell
C:\stic> icacls c:\Users
c:\Users NT AUTHORITY\SYSTEM:(OI)(CI)(F)
         BUILTIN\Administrators:(OI)(CI)(F)
         BUILTIN\Users:(RX)
         BUILTIN\Users:(OI)(CI)(IO)(GR,GE)
         Everyone:(RX)
         Everyone:(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files
```

Usando el comando `icacls c:\users /grant pepe:f` podemos conceder al usuario `pepe` el control total sobre el directorio, pero dado que `(oi)` y `(ci)` no fueron incluidos en el comando, el usuario `pepe` sólo tendrá derechos sobre la carpeta `c:\users` pero no sobre los subdirectorios de usuario y los archivos contenidos en ellos.

```powershell
C:\stic> icacls c:\users /grant pepe:f
processed file: c:\users
Successfully processed 1 files; Failed processing 0 files
```

```powershell
C:\stic> >icacls c:\users
c:\users WS01\pepe:(F)
         NT AUTHORITY\SYSTEM:(OI)(CI)(F)
         BUILTIN\Administrators:(OI)(CI)(F)
         BUILTIN\Users:(RX)
         BUILTIN\Users:(OI)(CI)(IO)(GR,GE)
         Everyone:(RX)
         Everyone:(OI)(CI)(IO)(GR,GE)

Successfully processed 1 files; Failed processing 0 files
```


## NTFS vs. Share Permissions

Microsoft es dueño de mas del [70%](https://gs.statcounter.com/os-market-share/desktop/worldwide/) del mercado global en lo que respecta a sistemas operativos de escritorio. Es por eso que hay tanto esfuerzo por parte de los desarrolladores de malware en crear software malicioso para este sistema operativo. También vale la pena señalar que, al momento de redactar este modulo, la infame vulnerabilidad `EternalBlue` sigue rondando los sistemas Windows sin parchear que ejecutan `SMBv1` y a menudo allana el camino para que un ransomware tire abajo algunas organizaciones.

El protocolo `Server Message Block`[(SMB)](https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-smb/f210069c-7086-4dc2-885e-861d837df688) se utiliza en Windows para conectar recursos compartidos como archivos e impresoras, que define las extensiones de la especificación existente del `Common Internet File System (CIFS)` que han sido implementadas por Microsoft desde la publicación de la especificación `CIFS`. Se utiliza en entornos de grandes, medianas y pequeñas empresas. Vea la siguiente imagen para visualizar este concepto:

![[Pasted image 20221117220955.png]]

![[Pasted image 20221117221043.png]]

#### Share permissions

| **Permiso** | **Descripción** |
| --------------|-------------------|
| `Full Control` | Los usuarios pueden realizar todas las acciones dadas por los permisos de Cambio y Lectura, así como cambiar los permisos de los archivos y subcarpetas NTFS. | 
| `Change` | Los usuarios estan permitidos para leer, editar, borrar y agregar archivos y subcarpetas. |
| `Read` | Los usuarios estan habilitados para ver el contenido de los  archivos y de los subdirectorios. |

Hay que tener en cuenta que en la mayoría de los entornos de grandes empresas, los recursos compartidos se crean en una red de área de almacenamiento (SAN), en un dispositivo de almacenamiento conectado a la red (NAS) o en una partición separada en unidades a las que se accede a través de un sistema operativo de servidor como Windows Server. Si alguna vez nos encontramos con recursos compartidos en un sistema operativo de escritorio, se tratará de una pequeña empresa o podría ser un sistema de cabeza de playa utilizado por un probador de penetración o un atacante malicioso para recopilar y exfiltrar datos.

Si creamos una carpeta con la GUI de Windows y vamos a  la opción de `Advance Sharing` podremos configurar nuestro recurso compartido.

![[Pasted image 20221118024743.png]]

![[Pasted image 20221118025651.png]]

![[Pasted image 20221118024829.png]]

Notemos que el nombre del recurso compartido sera automaticamente el del recurso a compartir, esto se puede modificar. Tambien tenemos un limitador de conexiones simultaneas al recurso, esto es muy util en entornos reales grandes donde puede haber una gran concurrencia en el recurso.

![[Pasted image 20221118025547.png]]

De forma similar a los permisos NTFS, existe una `lista de control de acceso` (`ACL`) para los recursos compartidos. Podemos considerar esto como la lista de permisos SMB. Tenga en cuenta que con los recursos compartidos, tanto la lista de permisos SMB como la NTFS se aplican a cada recurso que se comparte en Windows. La ACL contiene `entradas de control de acceso` (`ACEs`). Normalmente, estas ACEs están formadas por `usuarios` y `grupos` (también llamados security principals), ya que son un mecanismo adecuado para gestionar y rastrear el acceso a los recursos compartidos.

Ahora para poder acceder por SMB a los recursos compartidos del sistema Windows podremos usar desde una terminal linux el aplicativo `smbclient`

SMB
```bash
smbclient -L IPaddressOfTarget -U stic
```

¿Qué podría bloquearnos el acceso a este recurso compartido si todas nuestras entradas son correctas y nuestra lista de permisos tiene el grupo `Everyone` presente con al menos permisos de Lectura?

### Consideraciones del Firewall de Windows Defender

Es el Firewall de Windows Defender el que podría estar bloqueando el acceso al recurso compartido SMB. Como nos estamos conectando desde un sistema basado en Linux, el firewall ha bloqueado el acceso desde cualquier dispositivo que no esté unido al mismo `grupo de trabajo` (`workgroup`). También es importante tener en cuenta que cuando un sistema Windows forma parte de un grupo de trabajo, todas las solicitudes de inicio de sesión en red (`netlogon`) se autentican contra la base de datos `SAM` de ese sistema Windows en particular. Cuando un sistema Windows se une a un entorno de dominio de Windows, todas las solicitudes de inicio de sesión en red se autentican contra `Active Directory`. La principal diferencia entre un grupo de trabajo y un dominio de Windows en términos de autenticación, es que con un grupo de trabajo se utiliza la base de datos SAM local y en un dominio de Windows se utiliza una base de datos centralizada basada en la red (Active Directory). Debemos conocer esta información cuando intentemos iniciar sesión y autenticarnos con un sistema Windows. 

El bloqueo de conexiones por parte del firewall, se puede comprobar desactivando completamente cada perfil del firewall en Windows o activando reglas específicas de firewall entrantes predefinidas en la `configuración de seguridad avanzada del cortafuegos de Windows Defender`. Como la mayoría de los firewall, el Firewall de Windows Defender permite o deniega el tráfico (solicitudes de acceso y conexión en este caso)  entrante y/o saliente.

Las diferentes reglas entrantes y salientes estan asociadas con los distintos perfiles del firewall en el Defender.

Perfiles del Firewall del Windows Defender:

- `Publico`
- `Privado`
- `Dominio`

Las reglas del cortafuegos en los sistemas de escritorio se pueden gestionar de forma centralizada cuando se unen a un entorno de dominio de Windows mediante el uso de los Politicas de Grupo (`Groups Policy`).

Una vez habilitadas las reglas del firewall de entrada adecuadas, nos conectaremos con éxito al recurso compartido. Una vez establecida la conexión con un recurso compartido, podemos crear un `punto de montaje` desde nuestro sistema Linux al sistema de archivos de la maquina Windows 10.

Aquí es donde también debemos considerar que los permisos NTFS se aplican junto con los permisos de uso compartido. Recordemos que NTFS es el sistema de archivos por defecto en Windows.

### ACL de los Permisos NTFS (Security Tab)

REEMPLAZAR!
![[Pasted image 20221118183831.png]]

Se puede aplicar un control más granular con los permisos NTFS que se pueden aplicar a los usuarios y grupos. Siempre que veamos una marca de verificación gris junto a un permiso, éste se heredó de un directorio padre. Por defecto, todos los permisos NTFS se heredan del directorio padre. En el mundo de Windows, la unidad `C:\` es el directorio raíz que rige todos los directorios, a menos que un administrador del sistema deshabilite la herencia dentro de la configuración de seguridad avanzada de una carpeta recién creada.

En la mayoria de los casos, los sysadmins son los responsables en una organizacion de otorgar permisos a grupos o usuarios dentro de una red de recursos, es por esto que suelen ser foco de ataques dirigidos como asi tambien lo son a los lideres de sectores IT.

Podemos conectarnos a un recurso compartido desde una sistema Linux usando una montura de tipo `CIFS`

Mount CIFS
```bash
sudo mount -t cifs -o username=stic,password=stic //ipaddoftarget/"Company Data" /home/user/Desktop/
```

Si el anterior comando tira error, verifiquen la sintaxis. En caso de seguir sin funcionar posiblemente necesiten instalar las `cifs-utils`

```bash
sudo apt-get install cifs-utils
```

Una vez montada la unidad, debemos mirar un par de herramientas que vienen instaladas en el propio Windows que nos permitiran monitorear y rastrear la montura que hemos creado.

Una de estas herramientas es `net share`, la cual te permite ver los recursos compartidos a nivel de red.

```powershell
C:\Users\skla3> net share

Share name   Resource                        Remark

-------------------------------------------------------------------------------
C$           C:\                             Default share
IPC$                                         Remote IPC
ADMIN$       C:\WINDOWS                      Remote Admin
Company Data C:\Users\skla3\Desktop\Company Data

The command completed successfully.
```

Como podemos ver, tenemos el recurso compartido nuestro. Pero además, podemos ver la unidad `C:\`. Si bien nosotros no compartimos la unidad `C` manualmente, esta se comparte al momento de instalar SMB. Esto permitiria a cualquiera acceder al disco `C` de otra maquina en la red si tiene los permisos necesarios, lo cual podría ser crítico.

### Computer Management

`Computer Management` es otra herramienta que nos permite identificar y monitorizar los recursos compartidos del sistema. 
<{todo} poner imagen del `Computer Management`>

En esta herramienta podemos visualizar los recursos compartidos, las sessiones y los archivos abiertos. Es un excelente lugar para empezar si tenemos que revisar una brecha de información. 

### Event Viewer

`Event Viewer` es otra excelente tool al momento de investigar acciones completadas en el sistema. Esta app centraliza el acceso a los logs del sistema,  estos logs cuentan con numerosos detalles. En este caso, podremos ver si nos conectamos al sistema Windows, creamos un recurso compartido y accedemos a él.

## Services & Processes

Los servicios son un componente muy importante en Windows. Son los encargados de mantener procesos de larga duracion. Estos pueden iniciarce automaticamente al booteo del sistema sin la necesidad de que un usuario intervenga, tambien algunos son capaces de seguir corriendo en background al momento de deslogearse de la cuenta de usuario en el sistema.

Por otro lado, tambien pueden crearse aplicaciones donde terminen instalando un servicio, como lo que son las aplicaciones de monitoreo de red instaladas en un servidor. Estos servicios son responsables de muchisimas funcionalidades, tales como las funciones de red, realizar diagnosticos del sistema, el manejo de credenciales y logeo y/o encargarse de las aplicaciones entre otros.

Los servcios de windows se pueden administrar mediante la aplicaciones de GUI `Service Control Manager` del sistema, al cual se puede acceder mediante `services.msc` que viene preinstalada en el sistema. En esta app encontraremos informacion relacionada a cada servicio, tales como nombre del servicio, descripcion, estado,  tipo de inicio y el usuario bajo el cual corre el servicio dado.

Tambien es posible interactuar, consultar y administrar los servicios mediante el aplicativo de linea de comandos `sc.exe` utilizando cmdlets como `Get-Service`

<{Agregar output de `PS C:\htb> Get-Service | ? {$_.Status -eq "Running"} | select -First 2 |fl `}>

```powershell
Get-Service | ? {$_.Status -eq "Running"} | select -First 2 |fl
```

Los estados de los servicios pueden ser `En Ejecucion`, `Detenido` ó `Pausado`, y sus tipos de arranque pueden ser `Automatico` , `Manual` ó con un `delay` luego del booteo del sistema.
Los servicios tambien pueden cambiar de estado si un evento dispara una acción que provoque el cambio de estado en estos.

Existen 3 tipos de servicios en windows:
- Local Services
- Network Services
- System Services

Los servicios por lo general pueden creados, modificados o eliminados por usuarios que tengan permisos de administrador. Una mala configuracion en los servicios suele ser el causante de una escalada de privilegios en Windows

En Windows hay ciertos servicios que se denominan [critical system services](https://docs.microsoft.com/en-us/windows/win32/rstmgr/critical-system-services), los cuales no pueden ser detenidos y reiniciados sin tener que reiniciar el sistema. Si se quiere modificar cualquier archivo en uso por uno de estos servicios, sera necesario reiniciar el sistema.

### critical system services

| **Servicio** | **Descripción** |
| --------------|-------------------|
| smss.exe | Session Manager SubSystem. Responsable de manejar las sesiones en el sistema. |
| csrss.exe | Client Server Runtime Process. La parte del subsistema Windows en modo usuario. |
| wininit.exe | Inicia el archivo Wininit.ini que enumera todos los cambios que deben realizarse en Windows cuando se reinicia el ordenador después de instalar un programa. |
| logonui.exe | Se usa para facilitar el inicio de sesion del usuario en el ordenador |
| lsass.exe | El servicio Local Security Authentication Server verifica la validez de los inicios de sesión de los usuarios en un PC o servidor. Genera el proceso responsable de autenticar a los usuarios para el servicio Winlogon. |
| services.exe | Administra las operaciones de iniciar y detener servicios. |
| winlogon.exe | Se encarga de gestionar la secuencia de atención segura, de cargar un perfil de usuario al iniciar la sesión y de bloquear el ordenador cuando se ejecuta un salvapantallas. |
| System | Un proceso del sistema en segundo plano que ejecuta el kernel de Windows. |
| svchost.exe with RPCSS | Gestiona los servicios del sistema que se ejecutan desde bibliotecas de enlaces dinámicos (archivos con la extensión .dll), como "Actualizaciones automáticas", "Firewall de Windows" y "Plug and Play". Utiliza el servicio Remote Procedure call (RPC) Service (RPCSS). |
| svchost.exe with Dcom/PnP | Gestiona los servicios del sistema que se ejecutan desde bibliotecas de enlaces dinámicos (archivos con la extensión .dll), como "Actualizaciones automáticas", "Firewall de Windows" y "Plug and Play". Utiliza los servicios "Distributed Component Object Model" (DCOM) y "Plug and Play" (PnP). |

[Lista de componentes de Windows](https://en.wikipedia.org/wiki/List_of_Microsoft_Windows_components#Services), incluyendo los key services.

### Procesos

Los procesos corren en segundo plano, estos pueden correr automaticamente como parte del sistema operativo o pueden ser iniciados por otra aplicacion instalada. 

Los procesos asociados a aplicaciones instaladas a menudo pueden terminar sin causar un impacto severo en el sistema operativo, pero hay algunos procesos que son _criticos_ y si estos terminan, conlleva a que algunos componentes del sistema operativo dejen de funcionar o funcionen incorrectamente. Algunos de estos procesos son `Windows Logon Application`, `System`, `System Idle Process`, `Windows Start-Up Application`, `Client Server Runtime`, `Windows Session Manager`, `Service Host`, y el proceso de  `Local Security Authority Subsystem Service` (`LSASS`).

### Local Security Authority Subsystem Service (LSASS)

`lsass.exe` es el proceso responsable de aplicar la política de seguridad en los sistemas Windows. Cuando un usuario intenta iniciar sesión en el sistema, este proceso verifica su intento de inicio de sesión y crea tokens de acceso basados en los niveles de permiso del usuario. LSASS también es responsable de los cambios de contraseña de las cuentas de usuario. Todos los eventos asociados a este proceso (intentos de inicio/cierre de sesión, etc.) se registran el Windows Security Log. Es por esto que LSASS es un objetivo de gran valor, ya que existen varias herramientas para extraer tanto el texto claro como las credenciales con hash almacenadas en la memoria por este proceso.

## Sysinternals Tools

LAS [SysInternals Tools suite](https://docs.microsoft.com/en-us/sysinternals) son un conjunto de aplicaciones para Windows portables que pueden ser usadas para administrar el sistema. La mayoria de estas herramientas pueden ser usadas sin necesitar descarga, esto se debe a que existe una version live la cual es accesible via internet y nos permite desde una terminar Powershell descargar y ejecutar alguna de ellas sin necesidad de que sean almacenadas en el sistema.

En el siguiente ejemplo ejecutaremos el aplicativo `procdump.exe` directamente sin necesidad de q sea guardada en el disco.
```powershell
C:\skla3> \\live.sysinternals.com\tools\procdump.exe -accepteula

ProcDump v9.0 - Sysinternals process dump utility
Copyright (C) 2009-2017 Mark Russinovich and Andrew Richards
Sysinternals - www.sysinternals.com

Monitors a process and writes a dump file when the process exceeds the
specified criteria or has an exception.

Capture Usage:
   procdump.exe [-mm] [-ma] [-mp] [-mc Mask] [-md Callback_DLL] [-mk]
                [-n Count]
                [-s Seconds]
                [-c|-cl CPU_Usage [-u]]
<SNIP>
```

Esta suite incluye herramientas tales como `Process Explorer`, una version mejorada de `Task Manager`, y `Process Monitor`, la cual puede ser usada para monitorizar el file system, los registros, la actividad de la red relacionada a cualquier proceso corriendo en el sistema. Algunas tools adicionales son `TCPView`  que se utiliza para monitorizar la actividad de internet, y `PSExec` la cual se utiliza para administrar/conectar los sistemas a travez del protocolo SMB remotamente.

Estas aplicaciones suelen ser utilizadas por pentesters para descubrir procesos interesantes, localizar posibles vias para una escalada de privilegios o tambien para realizar movimientos laterales. 

### Task Manager

El Administrador de Tareas de Windows es una potente herramienta para la gestión de los sistemas Windows. Proporciona información sobre los procesos en ejecución, el rendimiento del sistema, los servicios en ejecución, los programas de inicio, los usuarios registrados/los procesos de los usuarios registrados y los servicios. El Administrador de tareas puede abrirse haciendo clic con el botón derecho del ratón en la barra de tareas y seleccionando Administrador de tareas, pulsando ctrl + shift + Esc, pulsando ctrl + alt + del y seleccionando Administrador de tareas, abriendo el menú de inicio y escribiendo Administrador de tareas, o escribiendo `taskmgr` desde una consola CMD o PowerShell.

![[taskmgr.png]]

| **Servicio** | **Descripción** |
| --------------|-------------------|
| Pestaña Processes | Listado de Procesos que se estan ejecutando en primer o segundo plano, junto con su consumo de CPU, Memoria Ram, Disco, Red y la energia. | 
| Pestaña Performance | Muestra gráficos y datos como la utilización de la CPU, el tiempo de funcionamiento del sistema, el uso de la memoria, el disco y, la red y el uso de la GPU. También podemos abrir el `Resource Monitor`, que nos da una visión mucho más profunda del uso actual de los recursos de CPU, Memoria, Disco y Red. |

 ![[resource_monitor.png]]

| **Servicio** | **Descripción** |
| --------------|-------------------|
| Pestaña App History | Muestra el uso de recursos de la cuenta de usuario actual para cada aplicación durante un periodo de tiempo.
| Pestaña Startup |  Muestra qué aplicaciones están configuradas para iniciarse en el arranque, así como el impacto en el proceso de arranque.
| Pestaña Users | Muestra los usuarios conectados y los procesos/uso de recursos asociados a su sesión.  |
| Pestaña Details |  Muestra el nombre, el ID del proceso (PID), el estado, el nombre de usuario asociado, la CPU y el uso de la memoria de cada aplicación en ejecución. |
| Pestaña Services | Muestra el nombre, el PID, la descripción y el estado de cada servicio instalado. Desde esta pestaña también se puede acceder al complemento de Servicios. |

### Process Explorer

El aplicativo [`Process Explorer`](https://docs.microsoft.com/en-us/sysinternals/downloads/process-explorer) forma parte de la suite de Sysinternals. Esta herramienta muestra qué `handles` y DLLs tiene abierto o cargado un `proceso`. El `Process Explorer` 
esta subdividido en 2 pantallas, la superior muestra una lista de los procesos activos en ese momento, incluyendo los nombres de los usuarios propietarios, mientras q la información que se muestra en la ventana inferior depende en que modo estemos:
- `handle mode`: muestra los handle que el proceso seleccionado en la ventana superior ha abierto.
- `DLL mode`: muestra las DLL  y los archivos mapeados en memoria que el proceso cargó.

![[process_explorer.png]]

Este aplicativo también tiene una potente capacidad de búsqueda que le mostrará rápidamente qué procesos tienen abiertos determinados manejadores o DLLs cargados. Las capacidades del mismo lo hacen útil para rastrear problemas de versión de DLL o fugas de `handles`, y proporcionan una visión de la forma en que Windows y las aplicaciones funcionan.

Buscando procesos y servicios:
- PS: `Get-Process | Select-Object Processname,id`
- PS: `Get-Service | ? {$_.Status -eq "Running"} | select -First 2 | fl
- cmd: tasklist

## Service Permissions
- `services.msc`
Path to the executable is the full path to the program and command to execute when the service starts. If the NTFS permissions of the destination directory are configured with weak permissions, an attacker could replace the original executable with one created for malicious purposes.

The recovery tab allows steps to be configured should a service fail. Notice how this service can be set to run a program after the first failure. This is yet another vector that an attacker could use to run malicious programs by utilizing a legitimate service.

Notable built-in service accounts in Windows:
-   LocalService
-   NetworkService
-   LocalSystem

### sc
```powershell
C:\Users\skla3>sc qc wuauserv
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: wuauserv
        TYPE               : 20  WIN32_SHARE_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\WINDOWS\system32\svchost.exe -k netsvcs -p
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Windows Update
        DEPENDENCIES       : rpcss
        SERVICE_START_NAME : LocalSystem
```

```powershell
C:\Users\skla3>sc //hostname or ip of box query ServiceName
```

```powershell
C:\Users\skla3> sc stop wuauserv

[SC] OpenService FAILED 5:

Access is denied.
```

```cmd
C:\WINDOWS\system32> sc config wuauserv binPath=C:\Winbows\Perfectlylegitprogram.exe

[SC] ChangeServiceConfig SUCCESS

C:\WINDOWS\system32> sc qc wuauserv

[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: wuauserv
        TYPE               : 20  WIN32_SHARE_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Winbows\Perfectlylegitprogram.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Windows Update
        DEPENDENCIES       : rpcss
        SERVICE_START_NAME : LocalSystem
```

`sc sdshow`
```powershell
C:\WINDOWS\system32> sc sdshow wuauserv

D:(A;;CCLCSWRPLORC;;;AU)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;BA)(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;SY)S:(AU;FA;CCDCLCSWRPWPDTLOSDRCWDWO;;;WD)
```
`Security Descriptor Definition Language` (`SDDL`).
Every named object in Windows is a [securable object](https://docs.microsoft.com/en-us/windows/win32/secauthz/securable-objects), and even some unnamed objects are securable. If it's securable in a Windows OS, it will have a [security descriptor](https://docs.microsoft.com/en-us/windows/win32/secauthz/security-descriptors). Security descriptors identify the object’s owner and a primary group containing a `Discretionary Access Control List` (`DACL`) and a `System Access Control List` (`SACL`).

```powershell
PS C:\Users\skla3> Get-ACL -Path HKLM:\System\CurrentControlSet\Services\wuauserv | Format-List

Path   : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\wuauserv
Owner  : NT AUTHORITY\SYSTEM
Group  : NT AUTHORITY\SYSTEM
Access : BUILTIN\Users Allow  ReadKey
         BUILTIN\Users Allow  -2147483648
         BUILTIN\Administrators Allow  FullControl
         BUILTIN\Administrators Allow  268435456
         NT AUTHORITY\SYSTEM Allow  FullControl
         NT AUTHORITY\SYSTEM Allow  268435456
         CREATOR OWNER Allow  268435456
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadKey
         APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  -2147483648
         S-1-15-3-1024-1065365936-1281604716-3511738428-1654721687-432734479-3232135806-4053264122-3456934681 Allow
         ReadKey
         S-1-15-3-1024-1065365936-1281604716-3511738428-1654721687-432734479-3232135806-4053264122-3456934681 Allow
         -2147483648
Audit  :
Sddl   : O:SYG:SYD:AI(A;ID;KR;;;BU)(A;CIIOID;GR;;;BU)(A;ID;KA;;;BA)(A;CIIOID;GA;;;BA)(A;ID;KA;;;SY)(A;CIIOID;GA;;;SY)(A
         ;CIIOID;GA;;;CO)(A;ID;KR;;;AC)(A;CIIOID;GR;;;AC)(A;ID;KR;;;S-1-15-3-1024-1065365936-1281604716-3511738428-1654
         721687-432734479-3232135806-4053264122-3456934681)(A;CIIOID;GR;;;S-1-15-3-1024-1065365936-1281604716-351173842
         8-1654721687-432734479-3232135806-4053264122-3456934681)
```

the SID that represents each security principal (User and/or Group) is present in the SDDL.

## Sessions
#### Interactive
An interactive, or local logon session, is initiated by a user authenticating to a local or domain system by entering their credentials.
`runas`

#### Non-interactive
used by the Windows operating system to automatically start services and applications without requiring user interaction.

| **Account** | **Description** |
| --------------|-------------------|
| Local System Account | Also known as the `NT AUTHORITY\SYSTEM` account, this is the most powerful account in Windows systems. It is used for a variety of OS-related tasks, such as starting Windows services. This account is more powerful than accounts in the local administrators group. |
| Local Service Account | Known as the `NT AUTHORITY\LocalService` account, this is a less privileged version of the SYSTEM account and has similar privileges to a local user account. It is granted limited functionality and can start some services. |
| Network Service Account | This is known as the `NT AUTHORITY\NetworkService` account and is similar to a standard domain user account. It has similar privileges to the Local Service Account on the local machine. It can establish authenticated sessions for certain network services. |

#### Interacting with the Operating System
- [RDP](https://support.microsoft.com/en-us/help/186607/understanding-the-remote-desktop-protocol-rdp) port 3389 

[Windows Command Reference](https://download.microsoft.com/download/5/8/9/58911986-D4AD-4695-BF63-F734CD4DF8F2/ws-commands.pdf)

#### [cmdlet](https://docs.microsoft.com/en-us/powershell/scripting/developer/cmdlet/cmdlet-overview?view=powershell-7)

is a lightweight command that is used in the PowerShell environment.
Cmdlets are in the form of `Verb-Noun`. For example, the command `Get-ChildItem` can be used to list our current directory. Cmdlets also take arguments or flags. We can type `Get-ChildItem -` and hit the tab key to iterate through the arguments.

#### Aliases

Many cmdlets in PowerShell also have aliases. For example, the aliases for the cmdlet `Set-Location`, to change directories, is either `cd` or `sl`. Meanwhile, the aliases for `Get-ChildItem` are `ls` and `gci`. We can view all available aliases by typing `Get-Alias`.

```powershell
PS C:\skla3> New-Alias -Name "Show-Files" Get-ChildItem
PS C:\> Get-Alias -Name "Show-Files"

CommandType     Name                                               Version    Source
-----------     ----                                               -------    ------
Alias           Show-Files
```

```powershell
PS C:\Users\skla3> Get-Alias | findstr ipconfig
Alias           ifconfig -> ipconfig.exe
```


#### Execution Policy

| **Account** | **Description** |
| --------------|-------------------|
| `AllSigned` | All scripts can run, but a trusted publisher must sign scripts and configuration files. This includes both remote and local scripts. We receive a prompt before running scripts signed by publishers that we have not yet listed as either trusted or untrusted. |
| `Bypass` | No scripts or configuration files are blocked, and the user receives no warnings or prompts. |
| `Default` | This sets the default execution policy, `Restricted` for Windows desktop machines and `RemoteSigned` for Windows servers. |
| `RemoteSigned` | Scripts can run but requires a digital signature on scripts that are downloaded from the internet. Digital signatures are not required for scripts that are written locally. |
| `Restricted` | This allows individual commands but does not allow scripts to be run. All script file types, including configuration files (`.ps1xml`), module script files (`.psm1`), and PowerShell profiles (`.ps1`) are blocked. |
| `Undefined` | No execution policy is set for the current scope. If the execution policy for ALL scopes is set to undefined, then the default execution policy of `Restricted` will be used. |
| `Unrestricted` | This is the default execution policy for non-Windows computers, and it cannot be changed. This policy allows for unsigned scripts to be run but warns the user before running scripts that are not from the local intranet zone. |

A user can easily bypass the policy by either typing the script contents directly into the PowerShell window, downloading and invoking the script, or specifying the script as an encoded command. It can also be bypassed by adjusting the execution policy (if the user has the proper rights) or setting the execution policy for the current process scope

```powershell
PS C:\skla3> Get-ExecutionPolicy -List

        Scope ExecutionPolicy
        ----- ---------------
MachinePolicy       Undefined
   UserPolicy       Undefined
      Process       Undefined
  CurrentUser       Undefined
 LocalMachine    RemoteSigned
```

```powershell
PS C:\skla3> Set-ExecutionPolicy Bypass -Scope Process

Execution Policy Change
The execution policy helps protect you from scripts that you do not trust. Changing the execution policy might expose
you to the security risks described in the about_Execution_Policies help topic at
https:/go.microsoft.com/fwlink/?LinkID=135170. Do you want to change the execution policy?
[Y] Yes  [A] Yes to All  [N] No  [L] No to All  [S] Suspend  [?] Help (default is "N"): Y
```

```powershell
PS C:\skla3>  Get-ExecutionPolicy -List

        Scope ExecutionPolicy
        ----- ---------------
MachinePolicy       Undefined
   UserPolicy       Undefined
      Process          Bypass
  CurrentUser       Undefined
 LocalMachine    RemoteSigned
```

```powershell
PS C:\Users\skla3> Get-WmiObject -Class Win32_OperatingSystem | findstr SerialNumber
SerialNumber    : 00329-10280-00000-AA938
PS C:\Users\skla3> Get-WmiObject -Class Win32_OperatingSystem | Select SerialNumber

SerialNumber
------------
00329-10280-00000-AA938


PS C:\Users\skla3>
```

## Windows Management Instrumentation (WMI)


| **Component Name** | **Description** |
| --------------|-------------------|
| WMI service | The Windows Management Instrumentation process, which runs automatically at boot and acts as an intermediary between WMI providers, the WMI repository, and managing applications. |
| Managed objects | Any logical or physical components that can be managed by WMI. |
| WMI providers | Objects that monitor events/data related to a specific object. |
| Classes | These are used by the WMI providers to pass data to the WMI service. |
| Methods | These are attached to classes and allow actions to be performed. For example, methods can be used to start/stop processes on remote machines. |
| WMI repository | A database that stores all static data related to WMI. |
| CMI Object Manager | The system that requests data from WMI providers and returns it to the application requesting it. |
| WMI API | Enables applications to access the WMI infrastructure. |
| WMI Consumer | Sends queries to objects via the CMI Object Manager. |

Some of the uses for WMI are:

-   Status information for local/remote systems
-   Configuring security settings on remote machines/applications
-   Setting and changing user and group permissions
-   Setting/modifying system properties
-   Code execution
-   Scheduling processes
-   Setting up logging

These tasks can all be performed using a combination of PowerShell and the WMI Command-Line Interface (WMIC). WMI can be run via the Windows command prompt by typing `WMIC` to open an interactive shell or by running a command directly such as `wmic computersystem get name` to get the hostname. We can view a listing of WMIC commands and aliases by typing `WMIC /?`.

The following command example lists information about the operating system.

```powershell
C:\skla3> wmic os list brief

BuildNumber  Organization  RegisteredUser  SerialNumber             SystemDirectory      Version
19041                      Owner           00123-00123-00123-AAOEM  C:\Windows\system32  10.0.19041
```

WMIC uses aliases and associated verbs, adverbs, and switches. The above command example uses `LIST` to show data and the adverb `BRIEF` to provide just the core set of properties. An in-depth listing of verbs, switches, and adverbs is available [here](https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmic). WMI can be used with PowerShell by using the `Get-WmiObject` [module](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-wmiobject?view=powershell-5.1). This module is used to get instances of WMI classes or information about available classes. This module can be used against local or remote machines.

```powershell
PS C:\skla3> Get-WmiObject -Class Win32_OperatingSystem | select SystemDirectory,BuildNumber,SerialNumber,Version | ft

SystemDirectory     BuildNumber SerialNumber            Version
---------------     ----------- ------------            -------
C:\Windows\system32 19041       00123-00123-00123-AAOEM 10.0.19041
```

We can also use the `Invoke-WmiMethod` [module](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/invoke-wmimethod?view=powershell-5.1), which is used to call the methods of WMI objects. A simple example is renaming a file. We can see that the command completed properly because the `ReturnValue` is set to 0.

```powershell
PS C:\skla3> Invoke-WmiMethod -Path "CIM_DataFile.Name='C:\users\public\spns.csv'" -Name Rename -ArgumentList "C:\Users\Public\kerberoasted_users.csv"


__GENUS          : 2
__CLASS          : __PARAMETERS
__SUPERCLASS     :
__DYNASTY        : __PARAMETERS
__RELPATH        :
__PROPERTY_COUNT : 1
__DERIVATION     : {}
__SERVER         :
__NAMESPACE      :
__PATH           :
ReturnValue      : 0
PSComputerName   :
```
## Desktop Experience vs. Server Core

Certain server applications cannot run on Server Core, including Microsoft Server Virtual Machine Manager 2019 (SCVMM), System Center Data Protection Manager 2019, SharePoint Server 2019, Project Server 2019.

In summary, Server Core is lighter weight and less resource-intensive but has a steeper learning curve and can be more difficult to manage. It also has some limitations, such as performing management tasks using certain GUI programs.

The following table shows some of the applications available on Server Core vs. Desktop Experience. This is a list of common applications and not an exhaustive list.

| **Application* | ****Server Core**** |**Desktop Experience**|
| --------------|-------------------|-------------------|
| Command prompt | Available | Available |
| Windows PowerShell/ Microsoft .NET | Available | Available |
| Regedit | Available | Available |
| Diskmgmt.msc | Not Available | Available |
| Server Manager | Not Available | Available |
| Mmc.exe | Not Available | Available |
| Eventvwr | Not Available | Available |
| Services.msc | Not Available | Available |
| Control Panel | Not Available | Available |
| Windows Explorer | Not Available | Available |
| Taskmgr | Available | Available |
| Internet Explorer or Edge | Not Available | Available |
| Remote Desktop Services | Available | Available |

## Windows Security Features

### Security Identifier (SID)

A SID consists of the Identifier Authority and the Relative ID (RID). In an Active Directory (AD) domain environment, the SID also includes the domain SID.

```powershell
PS C:\skla3> whoami /user

USER INFORMATION
----------------

User Name           SID
=================== =============================================
ws01\bob S-1-5-21-674899381-4069889467-2080702030-1002
```

```powershell
PS C:\Users\skla3> wmic useraccount get name,sid
Name                SID
Administrator       S-1-5-21-2614195641-1726409526-3792725429-500
oth3r.user          S-1-5-21-2614195641-1726409526-3792725429-1003
DefaultAccount      S-1-5-21-2614195641-1726409526-3792725429-503
defaultuser0        S-1-5-21-2614195641-1726409526-3792725429-1000
Guest               S-1-5-21-2614195641-1726409526-3792725429-501
skla3               S-1-5-21-2614195641-1726409526-3792725429-1002
mrb3n               S-1-5-21-2614195641-1726409526-3792725429-1001
WDAGUtilityAccount  S-1-5-21-2614195641-1726409526-3792725429-504
```

```powershell
(SID)-(revision level)-(identifier-authority)-(subauthority1)-(subauthority2)-(etc)
```

| **Number** | **Meaning** |**Description**|
| --------------|-------------------|-------------------|
| S | SID | Identifies the string as a SID. |
| 1 | Revision Level | To date, this has never changed and has always been `1`. |
| 5 | Identifier-authority | A 48-bit string that identifies the authority (the computer or network) that created the SID. |
| 21 | Subauthority1 | This is a variable number that identifies the user's relation or group described by the SID to the authority that created it. It tells us in what order this authority created the user's account. |
| 674899381-4069889467-2080702030 | Subauthority2 | Tells us which computer (or domain) created the number |
| 1002 | Subauthority3 | The RID that distinguishes one account from another. Tells us whether this user is a normal user, a guest, an administrator, or part of some other group |

### Security Accounts Manager (SAM) and Access Control Entries (ACE)

SAM grants rights to a network to execute specific processes.

The access rights themselves are managed by Access Control Entries (ACE) in Access Control Lists (ACL). The ACLs contain ACEs that define which users, groups, or processes have access to a file or to execute a process, for example.

The permissions to access a securable object are given by the security descriptor, classified into two types of ACLs: the `Discretionary Access Control List (DACL)` or `System Access Control List (SACL)`. Every thread and process started or initiated by a user goes through an authorization process. An integral part of this process is access tokens, validated by the Local Security Authority (LSA).


### User Account Control (UAC)

User Account Control (UAC) is a fundamental component of Microsoft's overall security vision. UAC helps mitigate the impact of malware. 

With UAC enabled, Windows 10 or Windows 11 prompts for consent or prompts for credentials of a valid local administrator account before starting a program or task that requires a full administrator access token. This prompt ensures that no malicious software can be silently installed.



![[uac_architecture.png]]

To better understand each component, review the [**tables**](https://learn.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works#user)

### Registry

The [Registry](https://en.wikipedia.org/wiki/Windows_Registry) is a hierarchical database in Windows critical for the operating system. It stores low-level settings for the Windows operating system and applications that choose to use it.

- Registry Editor(GUI) open with  `regedit`

The tree-structure consists of main folders (root keys) in which subfolders (subkeys) with their entries/files (values) are located. There are 11 different types of values that can be entered in a subkey.

| **Value** | **Type** |
| --------------|-------------------|
| REG_BINARY | Binary data in any form. |
| REG_DWORD | A 32-bit number. |
| REG_DWORD_LITTLE_ENDIAN | A 32-bit number in little-endian format. Windows is designed to run on little-endian computer architectures. Therefore, this value is defined as REG_DWORD in the Windows header files. |
| REG_DWORD_BIG_ENDIAN | A 32-bit number in big-endian format. Some UNIX systems support big-endian architectures. |
| REG_EXPAND_SZ | A null-terminated string that contains unexpanded references to environment variables (for example, "%PATH%"). It will be a Unicode or ANSI string depending on whether you use the Unicode or ANSI functions. To expand the environment variable references, use the [**ExpandEnvironmentStrings**](https://docs.microsoft.com/en-us/windows/win32/api/processenv/nf-processenv-expandenvironmentstringsa) function. |
| REG_LINK | A null-terminated Unicode string containing the target path of a symbolic link created by calling the [**RegCreateKeyEx**](https://docs.microsoft.com/en-us/windows/desktop/api/Winreg/nf-winreg-regcreatekeyexa) function with REG_OPTION_CREATE_LINK. |
| REG_MULTI_SZ | A sequence of null-terminated strings, terminated by an empty string (\0). The following is an example: _String1_\0_String2_\0_String3_\0_LastString_\0\0 The first \0 terminates the first string, the second to the last \0 terminates the last string, and the final \0 terminates the sequence. Note that the final terminator must be factored into the length of the string. |
| REG_NONE | No defined value type. |
| REG_QWORD | A 64-bit number. |
| REG_QWORD_LITTLE_ENDIAN | A 64-bit number in little-endian format. Windows is designed to run on little-endian computer architectures. Therefore, this value is defined as REG_QWORD in the Windows header files. |
| REG_SZ | A null-terminated string. This will be either a Unicode or an ANSI string, depending on whether you use the Unicode or ANSI functions. |

Source: [**registry values types**][https://docs.microsoft.com/en-us/windows/win32/sysinfo/registry-value-types]

Each folder under `Computer` is a key. The root keys all start with `HKEY`. A key such as `HKEY-LOCAL-MACHINE` is abbreviated to `HKLM`. HKLM contains all settings that are relevant to the local system. This root key contains six subkeys like `SAM`, `SECURITY`, `SYSTEM`, `SOFTWARE`, `HARDWARE`, and `BCD`, loaded into memory at boot time (except `HARDWARE` which is dynamically loaded).

![[resources/regedit.png]]

The entire system registry is stored in several files on the operating system. You can find these under `C:\Windows\System32\Config\`.

```powershell
PS C:\skla3> ls

    Directory: C:\Windows\system32\config

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         12/7/2019   4:14 AM                Journal
d-----         12/7/2019   4:14 AM                RegBack
d-----         12/7/2019   4:14 AM                systemprofile
d-----         8/12/2020   1:43 AM                TxR
-a----         8/13/2020   6:02 PM        1048576 BBI
-a----         6/25/2020   4:36 PM          28672 BCD-Template
-a----         8/30/2020  12:17 PM       33816576 COMPONENTS
-a----         8/13/2020   6:02 PM         524288 DEFAULT
-a----         8/26/2020   7:51 PM        4603904 DRIVERS
-a----         6/25/2020   3:37 PM          32768 ELAM
-a----         8/13/2020   6:02 PM          65536 SAM
-a----         8/13/2020   6:02 PM          65536 SECURITY
-a----         8/13/2020   6:02 PM       87818240 SOFTWARE
-a----         8/13/2020   6:02 PM       17039360 SYSTEM
```

The user-specific registry hive (HKCU) is stored in the user folder (i.e., `C:\Windows\Users\<USERNAME>\Ntuser.dat`).

```powershell
PS C:\skla3> gci -Hidden

    Directory: C:\Users\bob

Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d--h--         6/25/2020   5:12 PM                AppData
d--hsl         6/25/2020   5:12 PM                Application Data
d--hsl         6/25/2020   5:12 PM                Cookies
d--hsl         6/25/2020   5:12 PM                Local Settings
d--h--         6/25/2020   5:12 PM                MicrosoftEdgeBackups
d--hsl         6/25/2020   5:12 PM                My Documents
d--hsl         6/25/2020   5:12 PM                NetHood
d--hsl         6/25/2020   5:12 PM                PrintHood
d--hsl         6/25/2020   5:12 PM                Recent
d--hsl         6/25/2020   5:12 PM                SendTo
d--hsl         6/25/2020   5:12 PM                Start Menu
d--hsl         6/25/2020   5:12 PM                Templates
-a-h--         8/13/2020   6:01 PM        2883584 NTUSER.DAT
-a-hs-         6/25/2020   5:12 PM         524288 ntuser.dat.LOG1
-a-hs-         6/25/2020   5:12 PM        1011712 ntuser.dat.LOG2
-a-hs-         8/17/2020   5:46 PM        1048576 NTUSER.DAT{53b39e87-18c4-11ea-a811-000d3aa4692b}.TxR.0.regtrans-ms
-a-hs-         8/17/2020  12:13 PM        1048576 NTUSER.DAT{53b39e87-18c4-11ea-a811-000d3aa4692b}.TxR.1.regtrans-ms
-a-hs-         8/17/2020  12:13 PM        1048576 NTUSER.DAT{53b39e87-18c4-11ea-a811-000d3aa4692b}.TxR.2.regtrans-ms
-a-hs-         8/17/2020   5:46 PM          65536 NTUSER.DAT{53b39e87-18c4-11ea-a811-000d3aa4692b}.TxR.blf
-a-hs-         6/25/2020   5:15 PM          65536 NTUSER.DAT{53b39e88-18c4-11ea-a811-000d3aa4692b}.TM.blf
-a-hs-         6/25/2020   5:12 PM         524288 NTUSER.DAT{53b39e88-18c4-11ea-a811-000d3aa4692b}.TMContainer000000000
                                                  00000000001.regtrans-ms
-a-hs-         6/25/2020   5:12 PM         524288 NTUSER.DAT{53b39e88-18c4-11ea-a811-000d3aa4692b}.TMContainer000000000
                                                  00000000002.regtrans-ms
---hs-         6/25/2020   5:12 PM             20 ntuser.ini
```


#### [Run and RunOnce registry keys](https://docs.microsoft.com/en-us/windows/win32/setupapi/run-and-runonce-registry-keys).

Contain a logical group of keys, subkeys, and values to support software and files loaded into memory when the operating system is started or a user logs in.

The Windows registry includes the following four keys:

```powershell
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnce
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce
```

Here is an example of the `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run` key while logged in to a system.

```powershell
PS C:\skla3> reg query HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run

HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
    SecurityHealth    REG_EXPAND_SZ    %windir%\system32\SecurityHealthSystray.exe
    RTHDVCPL    REG_SZ    "C:\Program Files\Realtek\Audio\HDA\RtkNGUI64.exe" -s
    Greenshot    REG_SZ    C:\Program Files\Greenshot\Greenshot.exe
```

Here is an example of the `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run` showing applications running under the current user while logged in to a system.

```powershell
PS C:\skla3> reg query HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run

HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
    OneDrive    REG_SZ    "C:\Users\bob\AppData\Local\Microsoft\OneDrive\OneDrive.exe" /background
    OPENVPN-GUI    REG_SZ    C:\Program Files\OpenVPN\bin\openvpn-gui.exe
    Docker Desktop    REG_SZ    C:\Program Files\Docker\Docker\Docker Desktop.exe
```

### AppLocker

[AppLocker](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/applocker-overview) is Microsoft's application whitelisting solution and was first introduced in Windows 7. AppLocker gives system administrators control over which applications and files users can run. It gives granular control over executables, scripts, Windows installer files, DLLs, packaged apps, and packed app installers.

It allows for creating rules based on file attributes such as the publisher's name (which can be derived from the digital signature), product name, file name, and version. Rules can also be set up based on file paths and hashes. Rules can be applied to either security groups or individual users, based on the business need. AppLocker can be deployed in audit mode first to test the impact before enforcing all of the rules.


### Local Group Policy


Group Policy allows administrators to set, configure, and adjust a variety of settings. In a domain environment, group policies are pushed down from a Domain Controller onto all domain-joined machines that Group Policy objects (GPOs) are linked to. These settings can also be defined on individual machines using Local Group Policy.

Group Policy can be configured locally, in both domain environments and non-domain environments. Local Group Policy can be used to tweak certain graphical and network settings that are otherwise not accessible via the Control Panel. It can also be used to lock down an individual computer policy with stringent security settings, such as only allowing certain programs to be installed/run or enforcing strict user account password requirements.

We can open the Local Group Policy Editor by opening the Start menu and typing `gpedit.msc`. The editor is split into two categories under Local Computer Policy - `Computer Configuration` and `User Configuration`.

### Windows Defender Antivirus

Defender comes with several features such as real-time protection, which protects the device from known threats in real-time and cloud-delivered protection, which works in conjunction with automatic sample submission to upload suspicious files for analysis. When files are submitted to the cloud protection service, they are "locked" to prevent any potentially malicious behavior until the analysis is complete. Another feature is Tamper Protection, which prevents security settings from being changed through the Registry, PowerShell cmdlets, or group policy.

Real-time protection settings can be tweaked to add files, folders, and memory areas to controlled folder access to prevent unauthorized changes. We can also add files or folders to an exclusion list, so they are not scanned. An example would be excluding a folder of tools used for penetration testing from scanning as they will be flagged malicious and quarantined or removed from the system. Controlled folder access is Defender's built-in Ransomware protection.

We can use the PowerShell cmdlet `Get-MpComputerStatus` to check which protection settings are enabled.

```powershell
PS C:\htb> Get-MpComputerStatus | findstr "True"
AMServiceEnabled                : True
AntispywareEnabled              : True
AntivirusEnabled                : True
BehaviorMonitorEnabled          : True
IoavProtectionEnabled           : True
IsTamperProtected               : True
NISEnabled                      : True
OnAccessProtectionEnabled       : True
RealTimeProtectionEnabled       : True
```

Windows Defender will pick up payloads from common open-source frameworks such as Metasploit or unaltered versions of tools such as Mimikatz.